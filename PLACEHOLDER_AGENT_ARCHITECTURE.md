# åŸºäºAgentåŸºç¡€è®¾æ–½çš„ç»Ÿä¸€å ä½ç¬¦åˆ†æç³»ç»Ÿ

## ğŸ¯ æ¶æ„é‡æ„ç›®æ ‡

å°†æ··ä¹±çš„å¤šä¸ªå ä½ç¬¦å¤„ç†æ–‡ä»¶ç»Ÿä¸€ä¸ºä¸€ä¸ªçœŸæ­£åŸºäºç°æœ‰AgentåŸºç¡€è®¾æ–½çš„æ™ºèƒ½åˆ†æç³»ç»Ÿã€‚

## ğŸ“‹ é—®é¢˜åˆ†æ

### åŸæœ‰é—®é¢˜ï¼š
- **4ä¸ªé‡å¤çš„å ä½ç¬¦æ–‡ä»¶**ï¼š`placeholders.py`ã€`placeholders_agent.py`ã€`placeholders_simple.py`ã€`placeholders_backup.py`
- **é‡å¤ä»£ç ç‡ > 70%**ï¼šç›¸åŒé€»è¾‘åœ¨å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤å®ç°
- **åŸºç¡€è®¾æ–½åˆ©ç”¨ç‡ä½**ï¼šAgentå·¥å…·é“¾ã€DomainæœåŠ¡ã€LLMç­–ç•¥ç®¡ç†å™¨ç­‰å¼ºå¤§èƒ½åŠ›æœªè¢«å……åˆ†åˆ©ç”¨
- **æ¶æ„ä¸ä¸€è‡´**ï¼šä¼ ç»ŸDomainæœåŠ¡ä¸Agentä½“ç³»å¹¶å­˜ï¼Œç¼ºä¹ç»Ÿä¸€åè°ƒ

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### æ ¸å¿ƒç†å¿µï¼š**å……åˆ†åˆ©ç”¨ç°æœ‰AgentåŸºç¡€è®¾æ–½**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APIå±‚ (placeholders.py)                  â”‚
â”‚  PlaceholderOrchestrationService - åè°ƒå„å±‚æœåŠ¡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Applicationå±‚                             â”‚
â”‚  PlaceholderApplicationService - ä¸šåŠ¡æµç¨‹ç¼–æ’                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Domainå±‚                                â”‚
â”‚  PlaceholderAnalysisDomainService - ä¸šåŠ¡é€»è¾‘å’Œè§„åˆ™             â”‚
â”‚  â€¢ ä¸šåŠ¡éœ€æ±‚åˆ†æ                                                 â”‚
â”‚  â€¢ ä¸šåŠ¡è§„åˆ™éªŒè¯                                                 â”‚
â”‚  â€¢ è¯­ä¹‰ç±»å‹æ˜ å°„                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Infrastructureå±‚                             â”‚
â”‚                 å®Œæ•´çš„AgentåŸºç¡€è®¾æ–½                              â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   AgentFacade   â”‚  â”‚ UnifiedOrchestratorâ”‚  â”‚  StepExecutor â”‚ â”‚
â”‚  â”‚   ç»Ÿä¸€å…¥å£      â”‚  â”‚     ç¼–æ’å™¨        â”‚  â”‚   æ­¥éª¤æ‰§è¡Œå™¨     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    å·¥å…·é“¾ (Tools)                            â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â€¢ SchemaListColumnsTool    - æ•°æ®åº“ç»“æ„æŸ¥è¯¢               â”‚ â”‚
â”‚  â”‚  â€¢ SQLDraftTool            - æ™ºèƒ½SQLç”Ÿæˆ(è¯­ä¹‰è¯†åˆ«)          â”‚ â”‚
â”‚  â”‚  â€¢ SQLValidateTool         - SQLéªŒè¯                      â”‚ â”‚
â”‚  â”‚  â€¢ SQLRefineTool           - SQLä¼˜åŒ–                      â”‚ â”‚
â”‚  â”‚  â€¢ SQLExecuteTool          - SQLæ‰§è¡Œ                      â”‚ â”‚
â”‚  â”‚  â€¢ ChartSpecTool           - å›¾è¡¨è§„æ ¼                      â”‚ â”‚
â”‚  â”‚  â€¢ TimeWindowTool          - æ—¶é—´çª—å£                      â”‚ â”‚
â”‚  â”‚  â€¢ DataQualityTool         - æ•°æ®è´¨é‡                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 æ™ºèƒ½ç­–ç•¥ç®¡ç†                                 â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â€¢ llm_strategy_manager           - LLMç­–ç•¥ç®¡ç†å™¨           â”‚ â”‚
â”‚  â”‚  â€¢ data_source_security_service   - æ•°æ®æºå®‰å…¨æœåŠ¡          â”‚ â”‚
â”‚  â”‚  â€¢ auth_manager                  - è®¤è¯ç®¡ç†å™¨              â”‚ â”‚
â”‚  â”‚  â€¢ config_manager                - é…ç½®ç®¡ç†å™¨              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Agent Pipeline å·¥ä½œæµç¨‹

### å®Œæ•´çš„å ä½ç¬¦åˆ†ææµç¨‹ï¼š

```mermaid
graph TD
    A[APIè¯·æ±‚] --> B[PlaceholderOrchestrationService]
    B --> C[Domainå±‚ä¸šåŠ¡éœ€æ±‚åˆ†æ]
    C --> D[è¯­ä¹‰ç±»å‹æ˜ å°„]
    D --> E[æ„å»ºAgentè¾“å…¥]
    E --> F[Agent Pipelineæ‰§è¡Œ]

    F --> G[SchemaListColumnsTool]
    G --> H[SQLDraftTool + è¯­ä¹‰è¯†åˆ«]
    H --> I[SQLValidateTool]
    I --> J[SQLRefineTool]
    J --> K[å¯é€‰: SQLExecuteTool]

    K --> L[ç»“æœå¤„ç†å’Œå¢å¼º]
    L --> M[Domainå±‚ä¸šåŠ¡è§„åˆ™éªŒè¯]
    M --> N[ç»“æœæŒä¹…åŒ–]
    N --> O[è¿”å›å®Œæ•´ç»“æœ]
```

### æ ¸å¿ƒç‰¹æ€§ï¼š

1. **æ™ºèƒ½è¯­ä¹‰è¯†åˆ«**ï¼š
   - `ranking` - æ’è¡Œæ¦œç±»å‹ï¼ˆè‡ªåŠ¨æ·»åŠ TOP Né€»è¾‘ï¼‰
   - `compare` - å¯¹æ¯”ç±»å‹ï¼ˆç”ŸæˆåŸºå‡†å€¼ã€å¯¹æ¯”å€¼ã€å·®å€¼ã€ç™¾åˆ†æ¯”å˜åŒ–ï¼‰
   - `period` - å‘¨æœŸç±»å‹ï¼ˆæ—¶é—´ç²’åº¦åˆ†ç»„ï¼‰
   - `chart` - å›¾è¡¨ç±»å‹ï¼ˆä¼˜åŒ–å¯è§†åŒ–SQLï¼‰
   - `stat` - ç»Ÿè®¡ç±»å‹ï¼ˆé»˜è®¤ï¼‰

2. **å®Œæ•´å·¥å…·é“¾åˆ©ç”¨**ï¼š
   - è‡ªåŠ¨æŸ¥è¯¢æ•°æ®åº“ç»“æ„
   - æ™ºèƒ½SQLç”Ÿæˆå’Œä¼˜åŒ–
   - SQLéªŒè¯å’Œæµ‹è¯•
   - æ•°æ®è´¨é‡æ£€æŸ¥

3. **æ™ºèƒ½ç­–ç•¥ç®¡ç†**ï¼š
   - æ ¹æ®è¯­ä¹‰ç±»å‹è°ƒæ•´LLMç­–ç•¥
   - å®‰å…¨ç­–ç•¥æ£€æŸ¥
   - è®¤è¯å’Œæƒé™ç®¡ç†
   - é…ç½®åŠ¨æ€åŠ è½½

## ğŸ“Š APIæ¥å£è®¾è®¡

### ä¸»è¦æ¥å£ï¼š

1. **`POST /placeholders/analyze`** - ä½¿ç”¨å®Œæ•´Agent Pipelineåˆ†æ
2. **`POST /placeholders/batch-analyze`** - æ‰¹é‡Agent Pipelineåˆ†æ
3. **`POST /placeholders/test-sql`** - Agent SQLæµ‹è¯•
4. **æ ‡å‡†CRUDæ¥å£** - å ä½ç¬¦ç®¡ç†

### è¯·æ±‚ç¤ºä¾‹ï¼š

```json
{
  "placeholder_name": "top_sales_regions",
  "placeholder_text": "é”€å”®é¢å‰10çš„åœ°åŒºæ’è¡Œ",
  "template_id": "template_123",
  "data_source_id": "ds_456",
  "time_column": "order_date",
  "data_range": "month",
  "row_limit": 1000
}
```

### å“åº”ç¤ºä¾‹ï¼š

```json
{
  "success": true,
  "data": {
    "status": "success",
    "placeholder_name": "top_sales_regions",
    "generated_sql": {
      "sql": "SELECT region, SUM(sales_amount) as total_sales FROM sales WHERE order_date >= '2024-08-01' GROUP BY region ORDER BY total_sales DESC LIMIT 10"
    },
    "analysis_result": {
      "semantic_type": "ranking",
      "business_requirements": {
        "business_type": "ranking_analysis",
        "priority": "high",
        "top_n": 10
      },
      "execution_stats": {
        "tools_used": ["schema.list_columns", "sql.draft", "sql.validate"],
        "execution_time_ms": 1250,
        "agent_facade_used": true,
        "domain_service_used": true
      }
    },
    "confidence_score": 0.95,
    "business_validation": {
      "is_valid": true,
      "recommendations": ["å»ºè®®æ·»åŠ æ—¶é—´è¿‡æ»¤æ¡ä»¶"]
    }
  }
}
```

## ğŸš€ æ ¸å¿ƒä¼˜åŠ¿

### 1. **å®Œå…¨æ¶ˆé™¤é‡å¤ä»£ç **
- ä»4ä¸ªæ–‡ä»¶åˆå¹¶ä¸º1ä¸ªç»Ÿä¸€æ–‡ä»¶
- é‡å¤ä»£ç ç‡ä»70%é™è‡³0%

### 2. **å……åˆ†åˆ©ç”¨ç°æœ‰åŸºç¡€è®¾æ–½**
- ä½¿ç”¨å®Œæ•´çš„Agentå·¥å…·é“¾
- åˆ©ç”¨æ™ºèƒ½LLMç­–ç•¥ç®¡ç†å™¨
- é›†æˆæ•°æ®æºå®‰å…¨æœåŠ¡

### 3. **æ™ºèƒ½è¯­ä¹‰è¯†åˆ«**
- è‡ªåŠ¨è¯†åˆ«å ä½ç¬¦ç±»å‹
- é’ˆå¯¹æ€§SQLç”Ÿæˆç­–ç•¥
- ä¸šåŠ¡è§„åˆ™è‡ªåŠ¨éªŒè¯

### 4. **å®Œæ•´çš„å¯è§‚æµ‹æ€§**
- è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡
- å·¥å…·é“¾è¿½è¸ª
- æ€§èƒ½ç›‘æ§

### 5. **æ ‡å‡†åŒ–çš„é”™è¯¯å¤„ç†**
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
- è¯¦ç»†çš„é”™è¯¯ä¸Šä¸‹æ–‡
- ä¼˜é›…çš„é™çº§ç­–ç•¥

## ğŸ”§ éƒ¨ç½²å’Œè¿ç§»

### è¿ç§»æ­¥éª¤ï¼š
1. âœ… **å¤‡ä»½åŸæ–‡ä»¶** - å·²å°†åŸ`placeholders.py`é‡å‘½åä¸º`placeholders_old.py`
2. âœ… **æ¸…ç†å†—ä½™æ–‡ä»¶** - åˆ é™¤`placeholders_agent.py`ã€`placeholders_simple.py`ã€`placeholders_backup.py`
3. âœ… **éƒ¨ç½²æ–°ç³»ç»Ÿ** - æ–°çš„ç»Ÿä¸€`placeholders.py`å·²å°±ä½
4. **APIæµ‹è¯•** - éªŒè¯æ‰€æœ‰æ¥å£åŠŸèƒ½
5. **æ€§èƒ½ç›‘æ§** - è§‚å¯ŸAgent Pipelineæ‰§è¡Œæ•ˆç‡

### é…ç½®æ£€æŸ¥ï¼š
- ç¡®ä¿`app.core.container`é…ç½®æ­£ç¡®
- éªŒè¯Agentå·¥å…·æ³¨å†Œå®Œæ•´
- æ£€æŸ¥DomainæœåŠ¡ä¾èµ–

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

1. **ä»£ç è´¨é‡æå‡**ï¼šç»Ÿä¸€æ¶æ„ï¼Œæ¶ˆé™¤é‡å¤
2. **åŠŸèƒ½å¢å¼º**ï¼šæ™ºèƒ½è¯­ä¹‰è¯†åˆ«ï¼Œè‡ªåŠ¨åŒ–å·¥å…·é“¾
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šAgent Pipelineå¹¶è¡Œæ‰§è¡Œ
4. **å¯ç»´æŠ¤æ€§æå‡**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œæ ‡å‡†åŒ–æ¥å£
5. **æ‰©å±•æ€§å¢å¼º**ï¼šåŸºäºAgentå·¥å…·ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **APIæ¥å£æµ‹è¯•** - éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
2. **æ€§èƒ½åŸºå‡†æµ‹è¯•** - Agent Pipelineæ‰§è¡Œæ•ˆç‡
3. **é›†æˆæµ‹è¯•** - ä¸å‰ç«¯ç³»ç»Ÿé›†æˆéªŒè¯
4. **ç›‘æ§å‘Šè­¦** - æ·»åŠ å…³é”®æŒ‡æ ‡ç›‘æ§
5. **æ–‡æ¡£æ›´æ–°** - APIæ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

---

**æ¶æ„è´Ÿè´£äºº**: Claude Code Assistant
**è®¾è®¡æ—¥æœŸ**: 2025-09-26
**ç‰ˆæœ¬**: v2.0 - Agent Pipeline Based Architecture