name: API Documentation Update

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/app/api/**'
      - 'backend/app/schemas/**'
      - 'backend/app/models/**'
      - 'backend/app/main.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/app/api/**'
      - 'backend/app/schemas/**'
      - 'backend/app/models/**'
      - 'backend/app/main.py'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update documentation'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-api-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements/base.txt
        pip install -r requirements/development.txt
    
    - name: Set up environment
      run: |
        cd backend
        cp .env.example .env
        echo "DATABASE_URL=sqlite:///./test.db" >> .env
        echo "REDIS_URL=redis://localhost:6379" >> .env
    
    - name: Start Redis
      uses: supercharge/redis-github-action@1.7.0
      with:
        redis-version: 7
    
    - name: Initialize database
      run: |
        cd backend
        python scripts/init_db.py
    
    - name: Generate API documentation
      run: |
        cd backend
        python scripts/auto_update_docs.py --ci
      env:
        PYTHONPATH: .
    
    - name: Check documentation changes
      id: check_changes
      run: |
        cd backend
        if git diff --quiet docs/api/; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: api-documentation
        path: |
          backend/docs/api/
          !backend/docs/api/.auto_update_state.json
        retention-days: 30
    
    - name: Generate documentation summary
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        cd backend
        echo "## ğŸ“š APIæ–‡æ¡£æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡æ–‡æ¡£æ–‡ä»¶
        doc_count=$(find docs/api -name "*.md" | wc -l)
        json_count=$(find docs/api -name "*.json" | wc -l)
        
        echo "- ğŸ“„ Markdownæ–‡æ¡£: $doc_count ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ JSONè§„èŒƒ: $json_count ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ˜¾ç¤ºå˜æ›´çš„æ–‡ä»¶
        echo "### å˜æ›´çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        git diff --name-only docs/api/ | while read file; do
          echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç”Ÿæˆçš„æ–‡æ¡£" >> $GITHUB_STEP_SUMMARY
        echo "- [OpenAPIè§„èŒƒ](docs/api/generated/openapi.json)" >> $GITHUB_STEP_SUMMARY
        echo "- [Postmané›†åˆ](docs/api/generated/postman-collection.json)" >> $GITHUB_STEP_SUMMARY
        echo "- [APIä½¿ç”¨æŒ‡å—](docs/api/api-guide.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [æœ€ä½³å®è·µ](docs/api/best-practices.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [å¸¸è§é—®é¢˜](docs/api/faq.md)" >> $GITHUB_STEP_SUMMARY
    
    - name: Commit documentation updates
      if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'push'
      run: |
        cd backend
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/api/
        git commit -m "docs: è‡ªåŠ¨æ›´æ–°APIæ–‡æ¡£ [skip ci]" || exit 0
        git push
    
    - name: Create Pull Request
      if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: è‡ªåŠ¨æ›´æ–°APIæ–‡æ¡£"
        title: "ğŸ“š è‡ªåŠ¨æ›´æ–°APIæ–‡æ¡£"
        body: |
          ## ğŸ“š APIæ–‡æ¡£è‡ªåŠ¨æ›´æ–°
          
          æ­¤PRåŒ…å«åŸºäºæœ€æ–°APIå˜æ›´è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£æ›´æ–°ã€‚
          
          ### æ›´æ–°å†…å®¹
          - OpenAPIè§„èŒƒæ–‡ä»¶
          - Postmané›†åˆ
          - APIä½¿ç”¨æŒ‡å—
          - ç¤ºä¾‹ä»£ç 
          
          ### éªŒè¯æ­¥éª¤
          - [ ] æ£€æŸ¥OpenAPIè§„èŒƒæ ¼å¼æ­£ç¡®
          - [ ] éªŒè¯Postmané›†åˆå¯ç”¨
          - [ ] ç¡®è®¤æ–‡æ¡£å†…å®¹å‡†ç¡®
          
          ---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*
        branch: docs/api-update-${{ github.run_number }}
        delete-branch: true
    
    - name: Validate OpenAPI specification
      run: |
        cd backend
        # ä½¿ç”¨swagger-codegenéªŒè¯OpenAPIè§„èŒƒ
        if command -v swagger-codegen &> /dev/null; then
          swagger-codegen validate -i docs/api/generated/openapi.json
        else
          echo "swagger-codegen not available, skipping validation"
        fi
        
        # åŸºæœ¬JSONæ ¼å¼éªŒè¯
        python -c "
        import json
        with open('docs/api/generated/openapi.json', 'r') as f:
            spec = json.load(f)
        
        required_keys = ['openapi', 'info', 'paths']
        for key in required_keys:
            assert key in spec, f'Missing required key: {key}'
        
        print('âœ… OpenAPIè§„èŒƒéªŒè¯é€šè¿‡')
        "
    
    - name: Test documentation links
      run: |
        cd backend
        # æ£€æŸ¥æ–‡æ¡£ä¸­çš„å†…éƒ¨é“¾æ¥
        python -c "
        import re
        from pathlib import Path
        
        def check_markdown_links(file_path):
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # æŸ¥æ‰¾markdowné“¾æ¥
            links = re.findall(r'\[([^\]]+)\]\(([^)]+)\)', content)
            broken_links = []
            
            for text, link in links:
                if link.startswith('http'):
                    continue  # è·³è¿‡å¤–éƒ¨é“¾æ¥
                
                if link.startswith('#'):
                    continue  # è·³è¿‡é”šç‚¹é“¾æ¥
                
                # æ£€æŸ¥ç›¸å¯¹è·¯å¾„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                link_path = file_path.parent / link
                if not link_path.exists():
                    broken_links.append((text, link))
            
            return broken_links
        
        docs_dir = Path('docs/api')
        all_broken = []
        
        for md_file in docs_dir.rglob('*.md'):
            broken = check_markdown_links(md_file)
            if broken:
                all_broken.extend([(str(md_file), text, link) for text, link in broken])
        
        if all_broken:
            print('âŒ å‘ç°æŸåçš„é“¾æ¥:')
            for file_path, text, link in all_broken:
                print(f'  {file_path}: [{text}]({link})')
            exit(1)
        else:
            print('âœ… æ‰€æœ‰æ–‡æ¡£é“¾æ¥æ£€æŸ¥é€šè¿‡')
        "
    
    - name: Generate documentation metrics
      run: |
        cd backend
        python -c "
        import json
        from pathlib import Path
        
        docs_dir = Path('docs/api')
        
        # ç»Ÿè®¡æ–‡æ¡£æŒ‡æ ‡
        metrics = {
            'markdown_files': len(list(docs_dir.rglob('*.md'))),
            'json_files': len(list(docs_dir.rglob('*.json'))),
            'example_files': len(list(docs_dir.glob('examples/*.md'))),
            'total_size': sum(f.stat().st_size for f in docs_dir.rglob('*') if f.is_file()),
        }
        
        # åˆ†æOpenAPIè§„èŒƒ
        openapi_file = docs_dir / 'generated' / 'openapi.json'
        if openapi_file.exists():
            with open(openapi_file, 'r') as f:
                spec = json.load(f)
            
            metrics['api_endpoints'] = len([
                path for path, methods in spec.get('paths', {}).items()
                for method in methods.keys()
                if method in ['get', 'post', 'put', 'delete', 'patch']
            ])
            metrics['api_tags'] = len(spec.get('tags', []))
        
        print('ğŸ“Š æ–‡æ¡£æŒ‡æ ‡:')
        for key, value in metrics.items():
            print(f'  {key}: {value}')
        
        # ä¿å­˜æŒ‡æ ‡åˆ°æ–‡ä»¶
        with open('docs/api/metrics.json', 'w') as f:
            json.dump(metrics, f, indent=2)
        "
    
    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.check_changes.outputs.changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è¯»å–CIæŠ¥å‘Š
          const reportPath = path.join('backend', 'docs', 'api', 'ci_report.md');
          let reportContent = '';
          
          try {
            reportContent = fs.readFileSync(reportPath, 'utf8');
          } catch (error) {
            reportContent = 'æ— æ³•è¯»å–CIæŠ¥å‘Š';
          }
          
          const comment = `## ğŸ“š APIæ–‡æ¡£æ›´æ–°æŠ¥å‘Š
          
          ${reportContent}
          
          ### ğŸ” éªŒè¯ç»“æœ
          - âœ… OpenAPIè§„èŒƒæ ¼å¼æ­£ç¡®
          - âœ… æ–‡æ¡£é“¾æ¥æ£€æŸ¥é€šè¿‡
          - âœ… æ–‡æ¡£æŒ‡æ ‡ç”Ÿæˆå®Œæˆ
          
          ---
          *æ­¤è¯„è®ºç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  deploy-docs:
    needs: update-api-docs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download documentation artifacts
      uses: actions/download-artifact@v4
      with:
        name: api-documentation
        path: backend/docs/api/
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: backend/docs/api/
        destination_dir: api-docs
        commit_message: "docs: éƒ¨ç½²APIæ–‡æ¡£åˆ°GitHub Pages"
    
    - name: Update documentation index
      run: |
        echo "APIæ–‡æ¡£å·²éƒ¨ç½²åˆ°: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api-docs/"