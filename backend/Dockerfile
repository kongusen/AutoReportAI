# ==========================================
# AutoReportAI Backend Dockerfile
# React Agent Architecture - ç°ä»£åŒ–å¤šé˜¶æ®µæ„å»º
# ==========================================

# ==========================================
# åŸºç¡€Pythoné•œåƒ
# ==========================================
FROM python:3.11-slim AS base

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONFAULTHANDLER=1 \
    PYTHONHASHSEED=random \
    PYTHONIOENCODING=utf-8 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    DEBIAN_FRONTEND=noninteractive \
    PIP_NO_CACHE_DIR=on \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    PIP_DEFAULT_TIMEOUT=100

# å®‰è£…ç³»ç»Ÿä¾èµ– - åˆ†é˜¶æ®µå®‰è£…ä»¥å‡å°‘å†…å­˜ä½¿ç”¨
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    libpq-dev \
    libffi-dev \
    libssl-dev \
    git \
    postgresql-client \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…å­—ä½“æ”¯æŒ - å•ç‹¬å®‰è£…ä»¥é¿å…å†…å­˜ä¸è¶³
RUN apt-get update && apt-get install -y --no-install-recommends \
    fontconfig \
    fonts-dejavu \
    fonts-liberation \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…matplotlibä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    libfreetype6-dev \
    libpng-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…è½»é‡ä¸­æ–‡å­—ä½“
RUN apt-get update && apt-get install -y --no-install-recommends \
    fonts-wqy-microhei \
    && fc-cache -f \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd --gid 1000 appuser && \
    useradd --uid 1000 --gid appuser --shell /bin/bash --create-home appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºå†…è”å­—ä½“åˆå§‹åŒ–è„šæœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ğŸš€ AutoReportAI å­—ä½“åˆå§‹åŒ–"\n\
echo "æ›´æ–°å­—ä½“ç¼“å­˜..."\n\
fc-cache -fv\n\
echo "éªŒè¯ä¸­æ–‡å­—ä½“å®‰è£…..."\n\
CHINESE_FONTS=$(fc-list :lang=zh | wc -l)\n\
echo "æ£€æµ‹åˆ° $CHINESE_FONTS ä¸ªä¸­æ–‡å­—ä½“"\n\
if [ "$CHINESE_FONTS" -gt 0 ]; then\n\
    echo "âœ… ä¸­æ–‡å­—ä½“å®‰è£…æ­£å¸¸"\n\
else\n\
    echo "âŒ æœªæ£€æµ‹åˆ°ä¸­æ–‡å­—ä½“"\n\
fi\n\
mkdir -p /home/appuser/.cache/matplotlib\n\
chown -R appuser:appuser /home/appuser/.cache 2>/dev/null || true\n\
echo "âœ… å­—ä½“åˆå§‹åŒ–å®Œæˆ"\n\
' > /tmp/init_fonts.sh && \
chmod +x /tmp/init_fonts.sh && \
/tmp/init_fonts.sh && \
rm /tmp/init_fonts.sh

# ==========================================
# ä¾èµ–å®‰è£…é˜¶æ®µ
# ==========================================
FROM base AS dependencies

# å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt

FROM dependencies AS development

# å®‰è£…å¼€å‘ä¾èµ–
RUN pip install --no-cache-dir \
    watchdog \
    debugpy \
    ipython \
    jupyter \
    pytest \
    pytest-asyncio \
    pytest-cov \
    black \
    isort \
    flake8 \
    mypy

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser . .

# åˆ›å»ºReact Agentæ¶æ„å¿…è¦ç›®å½•
RUN mkdir -p logs cache storage temp uploads && \
    mkdir -p cache/llamaindex cache/react_agent cache/embeddings && \
    mkdir -p storage/templates storage/reports storage/exports && \
    chown -R appuser:appuser logs cache storage temp uploads

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY --chown=appuser:appuser entrypoint.sh /usr/local/bin/
COPY --chown=appuser:appuser healthcheck.sh /usr/local/bin/
COPY --chown=appuser:appuser healthcheck_worker.sh /usr/local/bin/

# è®¾ç½®è„šæœ¬æƒé™
RUN chmod +x /usr/local/bin/entrypoint.sh && \
    chmod +x /usr/local/bin/healthcheck.sh && \
    chmod +x /usr/local/bin/healthcheck_worker.sh

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD bash /usr/local/bin/healthcheck.sh

# å¯åŠ¨å‘½ä»¤
CMD ["/usr/local/bin/entrypoint.sh"]

# ==========================================
# Celery Workeræ„å»º - React Agentæ”¯æŒ
# ==========================================
FROM dependencies AS worker

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser . .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs cache storage temp uploads && \
    mkdir -p cache/llamaindex cache/react_agent cache/embeddings && \
    chown -R appuser:appuser logs cache storage temp uploads

# å¤åˆ¶å¥åº·æ£€æŸ¥è„šæœ¬
COPY --chown=appuser:appuser healthcheck_worker.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/healthcheck_worker.sh

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=60s --timeout=30s --start-period=10s --retries=3 \
    CMD bash /usr/local/bin/healthcheck_worker.sh

# å¯åŠ¨Celery Worker with React Agent support
CMD ["celery", "-A", "app.core.celery_scheduler", "worker", \
     "--loglevel=info", \
     "--concurrency=4", \
     "--max-tasks-per-child=1000", \
     "--without-gossip", \
     "--without-mingle", \
     "--without-heartbeat"]

# ==========================================
# Celery Beatæ„å»º
# ==========================================
FROM dependencies AS beat

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser . .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs cache storage temp uploads /tmp/celerybeat && \
    chown -R appuser:appuser logs cache storage temp uploads /tmp/celerybeat

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER appuser

# å¯åŠ¨Celery Beat
CMD ["celery", "-A", "app.core.celery_scheduler", "beat", \
     "--loglevel=info", \
     "--pidfile=/tmp/celerybeat/celerybeat.pid", \
     "--schedule=/tmp/celerybeat/celerybeat-schedule"]

# ==========================================
# ç”Ÿäº§ç¯å¢ƒæ„å»º
# ==========================================
FROM dependencies AS production

# å¤åˆ¶ç”Ÿäº§æ‰€éœ€æ–‡ä»¶
COPY --chown=appuser:appuser app ./app
COPY --chown=appuser:appuser scripts ./scripts
# åªå¤åˆ¶å­˜åœ¨çš„é…ç½®æ–‡ä»¶
COPY --chown=appuser:appuser requirements.txt ./
COPY --chown=appuser:appuser entrypoint.sh /usr/local/bin/
COPY --chown=appuser:appuser healthcheck.sh /usr/local/bin/

# åˆ›å»ºç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p logs cache storage temp uploads && \
    mkdir -p cache/llamaindex cache/react_agent cache/embeddings && \
    mkdir -p storage/templates storage/reports storage/exports && \
    chown -R appuser:appuser logs cache storage temp uploads

# è®¾ç½®è„šæœ¬æƒé™
RUN chmod +x /usr/local/bin/entrypoint.sh && \
    chmod +x /usr/local/bin/healthcheck.sh

# ç§»é™¤å¼€å‘æ–‡ä»¶
RUN rm -rf tests/ *.md .git/

# å®‰è£…Gunicorn for production
RUN pip install --no-cache-dir gunicorn

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD bash /usr/local/bin/healthcheck.sh

# ç”Ÿäº§å¯åŠ¨å‘½ä»¤
CMD ["gunicorn", "app.main:app", \
     "--worker-class", "uvicorn.workers.UvicornWorker", \
     "--workers", "4", \
     "--bind", "0.0.0.0:8000", \
     "--timeout", "120", \
     "--keep-alive", "2", \
     "--max-requests", "1000", \
     "--max-requests-jitter", "100"]