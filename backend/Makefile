.PHONY: test test-unit test-integration test-e2e test-coverage lint format migrate init-db clean dev-setup docs docs-generate docs-validate docs-serve

# ç¯å¢ƒå˜é‡
export DATABASE_URL ?= postgresql://test:test@localhost:5432/test_db
export PYTHONPATH := $(shell pwd)

# é¢œè‰²è¾“å‡º
GREEN := \033[32m
RED := \033[31m
YELLOW := \033[33m
NC := \033[0m

# é»˜è®¤ç›®æ ‡
help:
	@echo "$(GREEN)Backend Project Management Tool$(NC)"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  $(YELLOW)make test$(NC)         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  $(YELLOW)make test-unit$(NC)    - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  $(YELLOW)make test-integration$(NC) - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  $(YELLOW)make test-e2e$(NC)     - è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•"
	@echo "  $(YELLOW)make test-coverage$(NC) - è¿è¡Œè¦†ç›–ç‡æµ‹è¯•"
	@echo "  $(YELLOW)make migrate$(NC)      - è¿è¡Œæ•°æ®åº“è¿ç§»"
	@echo "  $(YELLOW)make init-db$(NC)      - åˆå§‹åŒ–æ•°æ®åº“"
	@echo "  $(YELLOW)make lint$(NC)         - ä»£ç æ£€æŸ¥"
	@echo "  $(YELLOW)make format$(NC)       - ä»£ç æ ¼å¼åŒ–"
	@echo "  $(YELLOW)make clean$(NC)        - æ¸…ç†æµ‹è¯•æ•°æ®"
	@echo "  $(YELLOW)make dev-setup$(NC)    - å¼€å‘ç¯å¢ƒè®¾ç½®"
	@echo "  $(YELLOW)make docs$(NC)         - ç”Ÿæˆå’ŒéªŒè¯APIæ–‡æ¡£"
	@echo "  $(YELLOW)make docs-generate$(NC) - ç”ŸæˆAPIæ–‡æ¡£"
	@echo "  $(YELLOW)make docs-validate$(NC) - éªŒè¯APIæ–‡æ¡£"
	@echo "  $(YELLOW)make docs-serve$(NC)   - å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨"

# å®‰è£…ä¾èµ–
install:
	@echo "$(GREEN)å®‰è£…ä¾èµ–...$(NC)"
	pip install -r requirements.txt
	pip install pytest pytest-cov pytest-asyncio black flake8

# æ•°æ®åº“è¿ç§»
migrate:
	@echo "$(GREEN)è¿è¡Œæ•°æ®åº“è¿ç§»...$(NC)"
	alembic upgrade head

# é™çº§è¿ç§»
migrate-down:
	@echo "$(YELLOW)é™çº§æ•°æ®åº“è¿ç§»...$(NC)"
	alembic downgrade -1

# é‡ç½®æ•°æ®åº“
reset-db:
	@echo "$(RED)é‡ç½®æ•°æ®åº“...$(NC)"
	alembic downgrade base
	alembic upgrade head

# åˆå§‹åŒ–æ•°æ®åº“
init-db:
	@echo "$(GREEN)åˆå§‹åŒ–æ•°æ®åº“...$(NC)"
	python scripts/init_db.py

# é…ç½®AIæä¾›å•†
configure-ai:
	@echo "$(GREEN)é…ç½®AIæä¾›å•†...$(NC)"
	python scripts/configure_ai_provider.py

# è¿è¡Œå•å…ƒæµ‹è¯•
test-unit:
	@echo "$(GREEN)è¿è¡Œå•å…ƒæµ‹è¯•...$(NC)"
	pytest tests/unit/ -v -m "not slow"

# è¿è¡Œé›†æˆæµ‹è¯•
test-integration:
	@echo "$(GREEN)è¿è¡Œé›†æˆæµ‹è¯•...$(NC)"
	pytest tests/integration/ -v

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
test-e2e:
	@echo "$(GREEN)è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•...$(NC)"
	pytest tests/e2e/ -v

# è¿è¡Œç®€å•E2Eæµ‹è¯•
test-e2e-simple:
	@echo "$(GREEN)è¿è¡Œç®€å•ç«¯åˆ°ç«¯æµ‹è¯•...$(NC)"
	python scripts/run_simple_e2e_test.py

# è¿è¡Œå®Œæ•´E2Eé›†æˆæµ‹è¯•
test-e2e-full:
	@echo "$(GREEN)è¿è¡Œå®Œæ•´ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•...$(NC)"
	python scripts/run_e2e_integration_tests.py

# è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
test-coverage:
	@echo "$(GREEN)è¿è¡Œè¦†ç›–ç‡æµ‹è¯•...$(NC)"
	pytest tests/ -v --cov=app --cov-report=html --cov-report=term

# ä»£ç æ£€æŸ¥
lint:
	@echo "$(GREEN)è¿è¡Œä»£ç æ£€æŸ¥...$(NC)"
	flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
	flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "$(GREEN)æ ¼å¼åŒ–ä»£ç ...$(NC)"
	black app/ --line-length 88
	black tests/ --line-length 88

# éªŒè¯Schema
validate-schema:
	@echo "$(GREEN)éªŒè¯Schemaä¸€è‡´æ€§...$(NC)"
	python -c "\
from app.db.session import engine; \
from sqlalchemy import inspect; \
inspector = inspect(engine); \
tables = inspector.get_table_names(); \
print('Tables:', tables); \
assert 'enhanced_data_sources' in tables; \
assert 'etl_jobs' in tables; \
print('âœ… Schema validation passed')"

# æ€§èƒ½åŸºå‡†æµ‹è¯•
perf-test:
	@echo "$(GREEN)è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•...$(NC)"
	pytest tests/integration/test_performance_benchmarks.py -v

# å®Œæ•´æµ‹è¯•æµç¨‹
test: install migrate test-unit test-integration validate-schema
	@echo "$(GREEN)æ‰€æœ‰æµ‹è¯•å®Œæˆï¼$(NC)"

# æ¸…ç†
clean:
	@echo "$(YELLOW)æ¸…ç†æµ‹è¯•æ•°æ®...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf .coverage

# å¼€å‘ç¯å¢ƒè®¾ç½®
dev-setup: install migrate init-db test-unit
	@echo "$(GREEN)å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆï¼$(NC)"

# ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥
prod-check: lint test-coverage
	@echo "$(GREEN)ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥å®Œæˆï¼$(NC)"

# APIæ–‡æ¡£ç”Ÿæˆå’ŒéªŒè¯
docs: docs-generate docs-validate
	@echo "$(GREEN)âœ… APIæ–‡æ¡£ç”Ÿæˆå’ŒéªŒè¯å®Œæˆ$(NC)"

# æ–‡æ¡£ç”Ÿæˆç›¸å…³å‘½ä»¤
.PHONY: docs-generate docs-update docs-serve docs-clean

docs-generate:
	@echo "ğŸš€ ç”ŸæˆAPIæ–‡æ¡£..."
	@cd $(BACKEND_DIR) && python scripts/generate_api_docs.py

docs-update:
	@echo "ğŸ”„ æ›´æ–°APIæ–‡æ¡£..."
	@cd $(BACKEND_DIR) && python scripts/update_api_docs.py --force

docs-watch:
	@echo "ğŸ‘€ ç›‘æ§APIæ–‡æ¡£å˜æ›´..."
	@cd $(BACKEND_DIR) && python scripts/update_api_docs.py --watch

docs-serve:
	@echo "ğŸŒ å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨..."
	@cd $(BACKEND_DIR)/docs/api && python -m http.server 8080

docs-clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„æ–‡æ¡£..."
	@rm -rf $(BACKEND_DIR)/docs/api/generated
	@rm -f $(BACKEND_DIR)/docs/api/.api_cache.json
