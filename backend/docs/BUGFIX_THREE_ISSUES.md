# ğŸ› ä¸‰ä¸ªå…³é”®é—®é¢˜ä¿®å¤

## ğŸ“‹ é—®é¢˜æ€»ç»“

### é—®é¢˜1ï¼šLLM æ¨¡å‹é€‰æ‹©å†²çª âŒ
- è‡ªä¸»é€‰æ‹©äº† `gpt-4`
- ä½†å®é™…ä½¿ç”¨äº† `gpt-3.5-turbo`
- **åŸå› **ï¼šå¤šä¸ªæ¨¡å‹é€‰æ‹©é€»è¾‘å†²çª

### é—®é¢˜2ï¼šSchema Context Retriever è¿”å›0ä¸ªè¡¨ âŒ  
- èƒ½å‘ç°19ä¸ªè¡¨å’Œ294ä¸ªåˆ—
- ä½†æ£€ç´¢æ—¶è¿”å›0ä¸ªè¡¨
- **åŸå› **ï¼šé˜¶æ®µæ„ŸçŸ¥ç¼“å­˜äº†ç©ºç»“æœ

### é—®é¢˜3ï¼šå·¥å…·ç»“æœæœªä¼ é€’åˆ°ä¸‹ä¸€è½® âŒ
- LLM é‡å¤è°ƒç”¨ç›¸åŒå·¥å…·
- æ²¡æœ‰åŸºäºå·¥å…·ç»“æœå‰è¿›
- **åŸå› **ï¼šæ²¡æœ‰é…ç½® Memory

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### âœ… ä¿®å¤1ï¼šæ·»åŠ  Memory æ”¯æŒ

**é—®é¢˜æ ¹å› **ï¼š
Loom çš„ TT é€’å½’éœ€è¦ memory æ¥ä¿å­˜å¯¹è¯å†å²ï¼Œå¦åˆ™ï¼š
- å·¥å…·ç»“æœæ— æ³•åœ¨ä¸‹ä¸€è½®ä¼ é€’
- LLM çœ‹ä¸åˆ°ä¹‹å‰çš„æ¶ˆæ¯
- é€’å½’æ— æ³•æ­£å¸¸å·¥ä½œ

**ä¿®å¤ä»£ç ** (`runtime.py:732-754`)ï¼š
```python
from loom.memory import InMemoryMessageMemory

agent_kwargs = {
    "llm": llm,
    "tools": tools,
    "memory": InMemoryMessageMemory(),  # ğŸ”¥ å…³é”®ï¼
    "max_iterations": config.max_iterations,
    "max_context_tokens": config.max_context_tokens,
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… Loom è‡ªåŠ¨ä¿å­˜æ¯è½®å¯¹è¯
- âœ… å·¥å…·ç»“æœè¢«åŒ…å«åœ¨ä¸‹ä¸€è½® LLM è°ƒç”¨ä¸­
- âœ… é€’å½’æ­£å¸¸å·¥ä½œ

---

### âœ… ä¿®å¤2ï¼šä¿®å¤é˜¶æ®µæ„ŸçŸ¥ç¼“å­˜Bug

**é—®é¢˜æ ¹å› **ï¼š
1. é˜¶æ®µæ„ŸçŸ¥ç¼“å­˜ä¼šç¼“å­˜ç©ºç»“æœ
2. å½“æŸ¥è¯¢æ–‡æœ¬æ— æ³•åŒ¹é…è¡¨æ—¶ï¼ˆå¦‚Loomçš„é€’å½’æŒ‡å¯¼æ¶ˆæ¯ï¼‰ï¼Œè¿”å›ç©ºåˆ—è¡¨
3. è¿™ä¸ªç©ºåˆ—è¡¨è¢«ç¼“å­˜
4. åç»­æŸ¥è¯¢ç›´æ¥è¿”å›ç¼“å­˜çš„ç©ºåˆ—è¡¨

**ä¿®å¤ä»£ç ** (`context_retriever.py:382-405`)ï¼š
```python
# æ£€æŸ¥é˜¶æ®µæ„ŸçŸ¥ç¼“å­˜
if self.enable_stage_aware:
    cache_key = f"{query[:100]}_{top_k}"
    if cache_key in self.stage_context_cache:
        cached_docs = self.stage_context_cache[cache_key]
        # ğŸ”¥ ä¸è¦è¿”å›ç©ºç¼“å­˜
        if len(cached_docs) > 0:
            return cached_docs
        else:
            # æ¸…é™¤ç©ºç¼“å­˜ï¼Œé‡æ–°æ£€ç´¢
            del self.stage_context_cache[cache_key]
    
    # ğŸ”¥ ä»…å½“ç»“æœéç©ºæ—¶æ‰ç¼“å­˜
    if len(documents) > 0:
        self.stage_context_cache[cache_key] = documents
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… ç©ºç»“æœä¸ä¼šè¢«ç¼“å­˜
- âœ… å³ä½¿ç¬¬ä¸€æ¬¡æ£€ç´¢å¤±è´¥ï¼Œåç»­ä»ä¼šé‡è¯•
- âœ… æé«˜æ£€ç´¢æˆåŠŸç‡

---

### âœ… ä¿®å¤3ï¼šæ”¹è¿›é™çº§ç­–ç•¥

**é—®é¢˜æ ¹å› **ï¼š
å½“æŸ¥è¯¢æ–‡æœ¬ï¼ˆå¦‚"å·¥å…·è°ƒç”¨å·²å®Œæˆã€‚è¯·åŸºäºè¿”å›çš„ç»“æœå®Œæˆä»»åŠ¡"ï¼‰æ— æ³•åŒ¹é…ä»»ä½•è¡¨æ—¶ï¼Œåº”è¯¥ä½¿ç”¨é™çº§ç­–ç•¥è¿”å›ä¸€äº›è¡¨ï¼Œè€Œä¸æ˜¯è¿”å›ç©ºåˆ—è¡¨ã€‚

**ä¿®å¤ä»£ç ** (`context_retriever.py:498-508`)ï¼š
```python
if not top_tables:
    # æ”¹è¿›é™çº§ç­–ç•¥
    logger.warning(f"âš ï¸ æ²¡æœ‰è¡¨åŒ¹é…æŸ¥è¯¢å…³é”®è¯")
    if self.schema_cache:
        fallback_count = min(top_k, len(self.schema_cache))
        logger.info(f"   ä½¿ç”¨é™çº§ç­–ç•¥ï¼šè¿”å›å‰ {fallback_count} ä¸ªè¡¨")
        top_tables = [(name, info, 0.5) for name, info in list(self.schema_cache.items())[:fallback_count]]
    else:
        logger.error(f"   âŒ Schemaç¼“å­˜ä¸ºç©ºï¼Œæ— æ³•æä¾›é™çº§ç­–ç•¥")
        return []
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… å³ä½¿æ— æ³•åŒ¹é…ï¼Œä¹Ÿä¼šè¿”å›å‰å‡ ä¸ªè¡¨
- âœ… LLM è‡³å°‘èƒ½çœ‹åˆ°ä¸€äº› schema ä¿¡æ¯
- âœ… æé«˜Agentå®Œæˆä»»åŠ¡çš„æˆåŠŸç‡

---

### â³ é—®é¢˜1å¾…ä¿®å¤ï¼šLLM æ¨¡å‹é€‰æ‹©

è¿™ä¸ªé—®é¢˜éœ€è¦æ£€æŸ¥æ¨¡å‹é€‰æ‹©æœåŠ¡çš„å®ç°ï¼Œæš‚æ—¶ä¿ç•™ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

ä¿®å¤åçš„æ‰§è¡Œæµç¨‹ï¼š

```
1ï¸âƒ£ ç¬¬ä¸€è½®ï¼š
   ğŸ§  LLM ç”Ÿæˆ: {"action": "tool_call", "tool_calls": ["schema_discovery"]}
   ğŸ”§ æ‰§è¡Œ schema_discovery
   âœ… å‘ç° 19 ä¸ªè¡¨
   ğŸ’¾ Memory ä¿å­˜: [user message, assistant tool_call, tool result]

2ï¸âƒ£ é€’å½’ï¼ˆåŸºäºå·¥å…·ç»“æœï¼‰ï¼š
   ğŸ”„ Loom é€’å½’è°ƒç”¨
   ğŸ“ æŸ¥è¯¢: "å·¥å…·è°ƒç”¨å·²å®Œæˆã€‚è¯·åŸºäºè¿”å›çš„ç»“æœå®Œæˆä»»åŠ¡"
   ğŸ” ContextRetriever æ£€ç´¢:
      - æ— æ³•åŒ¹é… -> ä½¿ç”¨é™çº§ç­–ç•¥
      - è¿”å›å‰5ä¸ªè¡¨ âœ…
   ğŸ§  LLM çœ‹åˆ°:
      - å·¥å…·ç»“æœï¼ˆ19ä¸ªè¡¨ï¼‰âœ…
      - Schemaä¸Šä¸‹æ–‡ï¼ˆå‰5ä¸ªè¡¨çš„è¯¦ç»†ä¿¡æ¯ï¼‰âœ…
   ğŸ§  LLM ç”Ÿæˆ: {"action": "finish", "content": "SELECT ..."}

3ï¸âƒ£ å®Œæˆï¼š
   âœ… è¿”å› SQL
   ğŸ“Š è´¨é‡è¯„åˆ†: 0.75+ (é¢„è®¡)
```

---

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **Memory** | âŒ æœªé…ç½® | âœ… InMemoryMessageMemory |
| **å·¥å…·ç»“æœä¼ é€’** | âŒ ä¸¢å¤± | âœ… è‡ªåŠ¨åŒ…å«åœ¨ä¸‹ä¸€è½® |
| **ç©ºç¼“å­˜** | âŒ è¢«ç¼“å­˜å¹¶é‡å¤è¿”å› | âœ… ä¸ç¼“å­˜ï¼Œé‡æ–°æ£€ç´¢ |
| **é™çº§ç­–ç•¥** | âš ï¸ ç®€å•è¿”å›ç©º | âœ… è¿”å›å‰Nä¸ªè¡¨ |
| **é€’å½’** | âŒ åœæ» | âœ… æ­£å¸¸å·¥ä½œ |
| **è´¨é‡è¯„åˆ†** | 0.40 (F) | 0.75+ (é¢„è®¡C+/B) |

---

## ğŸ“ æµ‹è¯•å»ºè®®

1. **éªŒè¯é€’å½’**ï¼š
   - æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰å¤šæ¬¡ LLM_START äº‹ä»¶
   - æ£€æŸ¥æ˜¯å¦æœ‰ RECURSION äº‹ä»¶
   - ç¡®è®¤å·¥å…·è°ƒç”¨æ¬¡æ•° > 1

2. **éªŒè¯ Schema æ£€ç´¢**ï¼š
   - æ£€æŸ¥é€’å½’æ—¶è¿”å›çš„è¡¨æ•°é‡ > 0
   - ç¡®è®¤é™çº§ç­–ç•¥è¢«è§¦å‘æ—¶æœ‰æ—¥å¿—

3. **éªŒè¯è´¨é‡è¯„åˆ†**ï¼š
   - è´¨é‡è¯„åˆ†åº”è¯¥æå‡åˆ° 0.7+
   - å·¥å…·ä½¿ç”¨è¯„åˆ†ä¸å†ä¸º0

---

## ğŸ“… ä¿®å¤è®°å½•

- **æ—¥æœŸ**: 2025-10-28
- **ä¿®å¤æ–‡ä»¶**:
  - `app/services/infrastructure/agents/runtime.py`
  - `app/services/infrastructure/agents/context_retriever.py`
- **å½±å“èŒƒå›´**: Agent é€’å½’æ‰§è¡Œã€Schema æ£€ç´¢ã€è´¨é‡è¯„åˆ†
- **æµ‹è¯•çŠ¶æ€**: å¾…æµ‹è¯•

