# å›¾è¡¨ç”Ÿæˆé›†æˆæ–¹æ¡ˆ - å®Œæ•´æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–¹æ¡ˆå®ç°äº†åŸºäºETLæ•°æ®çš„æ™ºèƒ½å›¾è¡¨ç”ŸæˆåŠŸèƒ½ï¼Œè®©Agentèƒ½å¤Ÿè¯†åˆ«`{{å›¾è¡¨ï¼šxxx}}`æ ¼å¼çš„å ä½ç¬¦ï¼Œè‡ªåŠ¨ç”Ÿæˆå›¾è¡¨å¹¶åµŒå…¥Wordæ–‡æ¡£ã€‚

---

## ğŸ¯ ä½ çš„æµç¨‹ç¼–æ’ï¼ˆtasks.pyï¼‰

### é˜¶æ®µ1ï¼šAgentç”ŸæˆSQL (Line 400-500)
```python
# 1. æ‰«ææ¨¡æ¿å ä½ç¬¦
# 2. Agentä¸ºæ¯ä¸ªå ä½ç¬¦ç”ŸæˆSQL
# 3. éªŒè¯å¹¶ä¿å­˜SQLåˆ°æ•°æ®åº“
```

### é˜¶æ®µ2ï¼šETLæ•°æ®å¤„ç† (Line 600-900)
```python
# æ‰§è¡Œæ‰€æœ‰å ä½ç¬¦çš„SQL
for ph in placeholders:
    # æ›¿æ¢æ—¶é—´å ä½ç¬¦
    final_sql = sql.replace("{{start_date}}", time_ctx['start_date'])

    # æ‰§è¡ŒæŸ¥è¯¢
    query_result = await connector.execute_query(final_sql)

    # å­˜å‚¨ç»“æœ
    etl_results[ph.placeholder_name] = actual_value
```

**å…³é”®ç‚¹**ï¼šæ­¤æ—¶`etl_results`å­—å…¸åŒ…å«æ‰€æœ‰å ä½ç¬¦çš„æŸ¥è¯¢ç»“æœï¼ŒåŒ…æ‹¬å›¾è¡¨å ä½ç¬¦çš„æ•°æ®ã€‚

### é˜¶æ®µ3ï¼šæ–‡æ¡£ç”Ÿæˆ (Line 918-996)
```python
# è°ƒç”¨WordTemplateServiceå¤„ç†æ–‡æ¡£
assemble_res = await word_service.process_document_template(
    template_path=tpl_meta['path'],
    placeholder_data=etl_results,  # ä¼ å…¥ETLç»“æœ
    output_path=docx_out,
    container=container,
    use_agent_charts=True,  # å¯ç”¨æ™ºèƒ½å›¾è¡¨ç”Ÿæˆ
    use_agent_optimization=True
)
```

---

## ğŸ”§ å®ç°çš„ç»„ä»¶

### 1. ChartGenerationTool (chart_tools.py)
**Agentå·¥å…·**ï¼Œæä¾›å›¾è¡¨ç”Ÿæˆèƒ½åŠ›ï¼š

```python
# è°ƒç”¨ç¤ºä¾‹
chart_tool = ChartGenerationTool()
result = await chart_tool.execute({
    "chart_type": "bar",
    "data": [{"å·å¸‚": "åŒ—äº¬", "ç”³è¯·é‡": 523}, ...],
    "title": "å·å¸‚é€€è´§ç”³è¯·é‡",
    "x_column": "å·å¸‚",
    "y_column": "ç”³è¯·é‡",
    "user_id": "user_123"
})

# è¿”å›
{
    "success": True,
    "chart_path": "/tmp/charts/user_123/chart_bar_xxx.png",
    "chart_type": "bar",
    "generation_time_ms": 245
}
```

**æ”¯æŒçš„å›¾è¡¨ç±»å‹**ï¼š
- `bar` - æŸ±çŠ¶å›¾
- `line` - æŠ˜çº¿å›¾
- `pie` - é¥¼å›¾
- `scatter` - æ•£ç‚¹å›¾
- `area` - é¢ç§¯å›¾

### 2. ChartDataAnalyzerTool (chart_tools.py)
**æ•°æ®åˆ†æå·¥å…·**ï¼Œæ¨èåˆé€‚çš„å›¾è¡¨ç±»å‹ï¼š

```python
analyzer = ChartDataAnalyzerTool()
result = await analyzer.execute({
    "data": [...],
    "intent": "æ˜¾ç¤ºæœˆåº¦é”€å”®è¶‹åŠ¿"
})

# è¿”å›
{
    "success": True,
    "recommended_chart_type": "line",
    "x_column": "month",
    "y_column": "sales",
    "reasoning": "æ•°æ®åŒ…å«æ—¶é—´åºåˆ—ï¼Œæ¨èä½¿ç”¨æŠ˜çº¿å›¾å±•ç¤ºè¶‹åŠ¿"
}
```

### 3. ChartPlaceholderProcessor (chart_placeholder_processor.py)
**å›¾è¡¨å ä½ç¬¦å¤„ç†å™¨**ï¼Œå¤„ç†æ–‡æ¡£ä¸­çš„å›¾è¡¨å ä½ç¬¦ï¼š

```python
processor = ChartPlaceholderProcessor(user_id="user_123")

# å¤„ç†å•ä¸ªå›¾è¡¨å ä½ç¬¦
result = await processor.process_chart_placeholder(
    placeholder_text="{{å›¾è¡¨ï¼šå·å¸‚é€€è´§ç”³è¯·é‡ç”±é«˜åˆ°ä½æ’åˆ—å¹¶æ˜¾ç¤ºå¯¹åº”ç”³è¯·é‡çš„æŸ±çŠ¶å›¾}}",
    data=etl_results[placeholder_key]
)
```

**åŠŸèƒ½**ï¼š
1. ä»å ä½ç¬¦æ–‡æœ¬æå–å›¾è¡¨æ„å›¾ï¼ˆç±»å‹ã€æ ‡é¢˜ã€æè¿°ï¼‰
2. è°ƒç”¨ChartDataAnalyzerToolåˆ†ææ•°æ®
3. è°ƒç”¨ChartGenerationToolç”Ÿæˆå›¾è¡¨
4. è¿”å›å›¾è¡¨æ–‡ä»¶è·¯å¾„

### 4. WordTemplateService (word_template_service.py)
**æ–‡æ¡£æ¨¡æ¿æœåŠ¡**ï¼Œå·²ä¿®æ”¹ä¸ºä½¿ç”¨ChartPlaceholderProcessorï¼š

```python
# _replace_chart_placeholders_with_agentæ–¹æ³•ï¼ˆLine 422-514ï¼‰
async def _replace_chart_placeholders_with_agent(self, doc, data, ...):
    chart_processor = ChartPlaceholderProcessor(user_id=user_id)

    for p in doc.paragraphs:
        if p.text.startswith("{{å›¾è¡¨ï¼š"):
            # è·å–ETLæ•°æ®
            chart_data = data.get(placeholder)

            # ç”Ÿæˆå›¾è¡¨
            chart_result = await chart_processor.process_chart_placeholder(
                placeholder_text=placeholder,
                data=chart_data
            )

            # æ’å…¥å›¾è¡¨åˆ°æ–‡æ¡£
            if chart_result["success"]:
                run = p.add_run()
                run.add_picture(chart_result["chart_path"], width=Inches(6.0))
```

---

## ğŸ“ å ä½ç¬¦æ ¼å¼

### æ ‡å‡†æ ¼å¼
```
{{å›¾è¡¨ï¼š[æè¿°][å›¾è¡¨ç±»å‹]}}
```

### ç¤ºä¾‹
```
{{å›¾è¡¨ï¼šå·å¸‚é€€è´§ç”³è¯·é‡ç”±é«˜åˆ°ä½æ’åˆ—å¹¶æ˜¾ç¤ºå¯¹åº”ç”³è¯·é‡çš„æŸ±çŠ¶å›¾}}
{{å›¾è¡¨ï¼šæœˆåº¦é”€å”®é¢è¶‹åŠ¿æŠ˜çº¿å›¾}}
{{å›¾è¡¨ï¼šäº§å“ç±»åˆ«é”€å”®å æ¯”é¥¼å›¾}}
{{å›¾è¡¨ï¼šä»·æ ¼ä¸é”€é‡å…³ç³»æ•£ç‚¹å›¾}}
```

### æå–é€»è¾‘
`ChartPlaceholderProcessor._extract_chart_intent()`ä¼šä»å ä½ç¬¦ä¸­æå–ï¼š

1. **å›¾è¡¨ç±»å‹**ï¼šé€šè¿‡å…³é”®è¯è¯†åˆ«
   - "æŸ±çŠ¶å›¾" â†’ bar
   - "æŠ˜çº¿å›¾" â†’ line
   - "é¥¼å›¾" â†’ pie
   - "æ•£ç‚¹å›¾" â†’ scatter

2. **æ ‡é¢˜**ï¼šå–æè¿°çš„å‰åŠéƒ¨åˆ†
   - "å·å¸‚é€€è´§ç”³è¯·é‡ç”±é«˜åˆ°ä½æ’åˆ—..." â†’ "å·å¸‚é€€è´§ç”³è¯·é‡"

3. **å®Œæ•´æè¿°**ï¼šç”¨äºæ•°æ®åˆ†æ

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1: Agentç”ŸæˆSQL (tasks.py Line 400-500)               â”‚
â”‚  - æ‰«æå ä½ç¬¦                                                â”‚
â”‚  - Agentç”ŸæˆSQL                                              â”‚
â”‚  - ä¿å­˜åˆ°æ•°æ®åº“                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2: ETLæ‰§è¡Œ (tasks.py Line 600-900)                    â”‚
â”‚  - æ‰§è¡Œæ‰€æœ‰SQLæŸ¥è¯¢                                           â”‚
â”‚  - æ›¿æ¢æ—¶é—´å ä½ç¬¦                                            â”‚
â”‚  - å­˜å‚¨åˆ° etl_results å­—å…¸                                  â”‚
â”‚                                                              â”‚
â”‚  etl_results = {                                            â”‚
â”‚    "å›¾è¡¨ï¼šå·å¸‚é€€è´§ç”³è¯·é‡...": [                              â”‚
â”‚      {"å·å¸‚": "åŒ—äº¬", "ç”³è¯·é‡": 523},                       â”‚
â”‚      {"å·å¸‚": "ä¸Šæµ·", "ç”³è¯·é‡": 412},                       â”‚
â”‚      ...                                                     â”‚
â”‚    ]                                                         â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ3: æ–‡æ¡£ç”Ÿæˆ (tasks.py Line 958)                        â”‚
â”‚  word_service.process_document_template(                    â”‚
â”‚    template_path=...,                                        â”‚
â”‚    placeholder_data=etl_results,  â† ETLæ•°æ®                 â”‚
â”‚    use_agent_charts=True                                     â”‚
â”‚  )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ4: å›¾è¡¨å¤„ç† (word_template_service.py Line 422)        â”‚
â”‚                                                              â”‚
â”‚  for æ–‡æ¡£ä¸­çš„æ¯ä¸ªæ®µè½:                                        â”‚
â”‚    if æ®µè½.text.startswith("{{å›¾è¡¨ï¼š"):                      â”‚
â”‚      â”œâ”€ ä»etl_resultsè·å–æ•°æ®                               â”‚
â”‚      â”œâ”€ ChartPlaceholderProcessor.process_chart_placeholder â”‚
â”‚      â”‚   â”œâ”€ æå–å›¾è¡¨æ„å›¾ (ç±»å‹ã€æ ‡é¢˜ã€æè¿°)                  â”‚
â”‚      â”‚   â”œâ”€ ChartDataAnalyzerTool.execute()                 â”‚
â”‚      â”‚   â”‚   â””â”€ åˆ†ææ•°æ®ï¼Œæ¨èå›¾è¡¨ç±»å‹                       â”‚
â”‚      â”‚   â”œâ”€ ChartGenerationTool.execute()                   â”‚
â”‚      â”‚   â”‚   â”œâ”€ éªŒè¯å‚æ•°                                     â”‚
â”‚      â”‚   â”‚   â”œâ”€ å‡†å¤‡æ•°æ®                                     â”‚
â”‚      â”‚   â”‚   â”œâ”€ ä½¿ç”¨matplotlibç”Ÿæˆå›¾è¡¨                       â”‚
â”‚      â”‚   â”‚   â””â”€ ä¿å­˜åˆ° /tmp/charts/user_id/chart_xxx.png   â”‚
â”‚      â”‚   â””â”€ è¿”å›å›¾è¡¨è·¯å¾„                                     â”‚
â”‚      â””â”€ æ’å…¥å›¾ç‰‡åˆ°Wordæ–‡æ¡£                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å·²å®Œæˆçš„é›†æˆ

### 1. âœ… Agentå·¥å…·æ³¨å†Œ
```python
# app/services/infrastructure/agents/tools/__init__.py (Line 95-96)
DEFAULT_TOOL_SPECS: Tuple[Tuple[str, str], ...] = (
    ...
    ("app.services.infrastructure.agents.tools.chart_tools", "ChartGenerationTool"),
    ("app.services.infrastructure.agents.tools.chart_tools", "ChartDataAnalyzerTool"),
)
```

### 2. âœ… WordTemplateServiceé›†æˆ
```python
# app/services/infrastructure/document/word_template_service.py (Line 422-514)
# å·²ä¿®æ”¹ä¸ºä½¿ç”¨ChartPlaceholderProcessor
```

### 3. âœ… tasks.pyæµç¨‹
```python
# app/services/infrastructure/task_queue/tasks.py (Line 958)
# å·²ç»è°ƒç”¨process_document_template with use_agent_charts=True
```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œé›†æˆæµ‹è¯•
```bash
cd /Users/shan/work/AutoReportAI/backend
python scripts/test_chart_integration.py
```

### æµ‹è¯•è¦†ç›–
1. âœ… å›¾è¡¨å ä½ç¬¦æå–æµ‹è¯•
2. âœ… æ•°æ®åˆ†æå’Œç±»å‹æ¨èæµ‹è¯•
3. âœ… å›¾è¡¨ç”Ÿæˆå·¥å…·æµ‹è¯•
4. âœ… Wordæ–‡æ¡£é›†æˆæµ‹è¯•
5. âœ… å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿtasks.pyï¼‰

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å›¾è¡¨ç”Ÿæˆæ—¶é—´è¿½è¸ª
```python
# ChartGenerationToolè¿”å›
{
    "generation_time_ms": 245  # å›¾è¡¨ç”Ÿæˆè€—æ—¶
}

# å¯ä»¥æ·»åŠ åˆ°chart_cache_service.pyçš„TODOå®ç°ä¸­
chart_generation_time_ms = chart_result.get("generation_time_ms", 0)
```

### ç¼“å­˜å»ºè®®
å¯¹äºç›¸åŒçš„æ•°æ®å’Œé…ç½®ï¼Œå¯ä»¥è€ƒè™‘ï¼š
1. ç¼“å­˜å›¾è¡¨æ–‡ä»¶ï¼ˆä½¿ç”¨æ•°æ®hashä½œä¸ºkeyï¼‰
2. ä½¿ç”¨PlaceholderChartCacheæ¨¡å‹å­˜å‚¨å›¾è¡¨ç»“æœ
3. æ·»åŠ TTLç®¡ç†è¿‡æœŸå›¾è¡¨

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœ¨æ¨¡æ¿ä¸­æ·»åŠ å›¾è¡¨å ä½ç¬¦
```docx
# é”€å”®åˆ†ææŠ¥å‘Š

## ç»Ÿè®¡æ•°æ®
æ€»é”€å”®é¢: {{total_sales}}
å¹³å‡é”€å”®é¢: {{avg_sales}}

## æ•°æ®å¯è§†åŒ–
{{å›¾è¡¨ï¼šå·å¸‚é€€è´§ç”³è¯·é‡ç”±é«˜åˆ°ä½æ’åˆ—å¹¶æ˜¾ç¤ºå¯¹åº”ç”³è¯·é‡çš„æŸ±çŠ¶å›¾}}

## è¶‹åŠ¿åˆ†æ
{{å›¾è¡¨ï¼šæœˆåº¦é”€å”®é¢è¶‹åŠ¿æŠ˜çº¿å›¾}}
```

### Agent SQLç”Ÿæˆ
Agentä¼šä¸ºå›¾è¡¨å ä½ç¬¦ç”ŸæˆSQLï¼š
```sql
-- ä¸º"å·å¸‚é€€è´§ç”³è¯·é‡"å ä½ç¬¦ç”Ÿæˆçš„SQL
SELECT å·å¸‚, COUNT(*) as ç”³è¯·é‡
FROM é€€è´§ç”³è¯·è¡¨
WHERE ç”³è¯·æ—¥æœŸ >= {{start_date}} AND ç”³è¯·æ—¥æœŸ <= {{end_date}}
GROUP BY å·å¸‚
ORDER BY ç”³è¯·é‡ DESC
```

### ETLæ‰§è¡Œ
```python
# ETLç»“æœ
etl_results = {
    "total_sales": 1780000,
    "avg_sales": 356000,
    "å›¾è¡¨ï¼šå·å¸‚é€€è´§ç”³è¯·é‡ç”±é«˜åˆ°ä½æ’åˆ—å¹¶æ˜¾ç¤ºå¯¹åº”ç”³è¯·é‡çš„æŸ±çŠ¶å›¾": [
        {"å·å¸‚": "åŒ—äº¬", "ç”³è¯·é‡": 523},
        {"å·å¸‚": "ä¸Šæµ·", "ç”³è¯·é‡": 412},
        {"å·å¸‚": "å¹¿å·", "ç”³è¯·é‡": 335},
        ...
    ]
}
```

### æ–‡æ¡£ç”Ÿæˆ
WordTemplateServiceè‡ªåŠ¨ï¼š
1. æ›¿æ¢æ–‡æœ¬å ä½ç¬¦ï¼ˆ`{{total_sales}}` â†’ 1780000ï¼‰
2. è¯†åˆ«å›¾è¡¨å ä½ç¬¦ï¼ˆ`{{å›¾è¡¨ï¼š...}}`ï¼‰
3. è°ƒç”¨ChartGenerationToolç”Ÿæˆå›¾è¡¨
4. å°†å›¾è¡¨æ’å…¥æ–‡æ¡£

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šå›¾è¡¨æ•°æ®æœªæ‰¾åˆ°
```
âŒ æ²¡æœ‰æ‰¾åˆ°å›¾è¡¨æ•°æ®: {{å›¾è¡¨ï¼šxxx}}
```
**åŸå› **ï¼šETLç»“æœä¸­çš„keyä¸å ä½ç¬¦æ–‡æœ¬ä¸åŒ¹é…

**è§£å†³**ï¼šæ£€æŸ¥ETLç»“æœçš„keyæ ¼å¼ï¼Œç¡®ä¿ä¸æ¨¡æ¿ä¸­çš„å ä½ç¬¦æ–‡æœ¬å®Œå…¨ä¸€è‡´

### é—®é¢˜2ï¼šå›¾è¡¨ç”Ÿæˆå¤±è´¥
```
âŒ å›¾è¡¨ç”Ÿæˆå¤±è´¥: æ•°æ®æ ¼å¼é”™è¯¯
```
**åŸå› **ï¼šæ•°æ®æ ¼å¼ä¸æ­£ç¡®

**è§£å†³**ï¼šç¡®ä¿ETLè¿”å›çš„æ•°æ®æ˜¯å­—å…¸åˆ—è¡¨æ ¼å¼ï¼š
```python
[
    {"åˆ—1": å€¼1, "åˆ—2": å€¼2},
    {"åˆ—1": å€¼3, "åˆ—2": å€¼4},
    ...
]
```

### é—®é¢˜3ï¼šmatplotlibæœªå®‰è£…
```
âš ï¸ å›¾è¡¨åº“æœªå®‰è£…ï¼Œè¯·å®‰è£… matplotlib
```
**è§£å†³**ï¼š
```bash
pip install matplotlib
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `app/services/infrastructure/agents/tools/chart_tools.py` - Agentå›¾è¡¨å·¥å…·
- `app/services/infrastructure/document/chart_placeholder_processor.py` - å›¾è¡¨å ä½ç¬¦å¤„ç†å™¨
- `app/services/infrastructure/document/word_template_service.py` - Wordæ¨¡æ¿æœåŠ¡
- `app/services/infrastructure/task_queue/tasks.py` - ä»»åŠ¡æ‰§è¡Œæµç¨‹

### æµ‹è¯•æ–‡ä»¶
- `scripts/test_chart_tool.py` - åŸºç¡€å·¥å…·æµ‹è¯•
- `scripts/test_chart_integration.py` - é›†æˆæµ‹è¯•

### æ¨¡å‹
- `app/models/placeholder_chart_cache.py` - å›¾è¡¨ç¼“å­˜æ¨¡å‹ï¼ˆå¾…å®Œå–„ï¼‰
- `app/services/cache/chart_cache_service.py` - å›¾è¡¨ç¼“å­˜æœåŠ¡ï¼ˆTODOæœªå®Œæˆï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **å›¾è¡¨ç¼“å­˜å®ç°**
   - å®Œæˆ`chart_cache_service.py`ä¸­çš„TODO
   - å®ç°å›¾è¡¨ç»“æœç¼“å­˜
   - æ·»åŠ `chart_generation_time_ms`è¿½è¸ª

2. **æ›´å¤šå›¾è¡¨ç±»å‹**
   - å †å æŸ±çŠ¶å›¾
   - åŒYè½´æŠ˜çº¿å›¾
   - æ¼æ–—å›¾
   - é›·è¾¾å›¾

3. **å›¾è¡¨æ ·å¼é…ç½®**
   - æ”¯æŒè‡ªå®šä¹‰é¢œè‰²æ–¹æ¡ˆ
   - æ”¯æŒå›¾è¡¨å°ºå¯¸é…ç½®
   - æ”¯æŒä¸­æ–‡å­—ä½“é…ç½®

4. **é”™è¯¯å¤„ç†å¢å¼º**
   - æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶
   - é™çº§æ–¹æ¡ˆä¼˜åŒ–

---

## ğŸ“ æ€»ç»“

âœ… **å·²å®Œæˆ**ï¼š
1. åˆ›å»ºäº†3ä¸ªAgentå·¥å…·ï¼ˆChartGenerationTool, ChartDataAnalyzerTool, ChartPlaceholderProcessorï¼‰
2. é›†æˆåˆ°WordTemplateService
3. æ³¨å†Œåˆ°Agentå·¥å…·ç³»ç»Ÿ
4. å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

âœ… **å·¥ä½œæµç¨‹**ï¼š
1. æ¨¡æ¿ä¸­ä½¿ç”¨`{{å›¾è¡¨ï¼šæè¿°}}`æ ¼å¼çš„å ä½ç¬¦
2. Agentç”ŸæˆSQLæŸ¥è¯¢æ•°æ®
3. ETLæ‰§è¡ŒSQLå¹¶å­˜å‚¨ç»“æœåˆ°etl_results
4. æ–‡æ¡£ç”Ÿæˆæ—¶ï¼ŒWordTemplateServiceè¯†åˆ«å›¾è¡¨å ä½ç¬¦
5. ChartPlaceholderProcessorè°ƒç”¨å›¾è¡¨å·¥å…·ç”Ÿæˆå›¾è¡¨
6. å›¾è¡¨è‡ªåŠ¨æ’å…¥Wordæ–‡æ¡£

âœ… **ç‰¹ç‚¹**ï¼š
- æ™ºèƒ½å›¾è¡¨ç±»å‹æ¨è
- åŸºäºETLæ•°æ®ç”Ÿæˆ
- æ”¯æŒå¤šç§å›¾è¡¨ç±»å‹
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

ğŸ‰ **ç°åœ¨ä½ çš„ç³»ç»Ÿå·²ç»æ”¯æŒæ™ºèƒ½å›¾è¡¨ç”Ÿæˆäº†ï¼**
