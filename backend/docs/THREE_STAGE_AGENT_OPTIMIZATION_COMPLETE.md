# ä¸‰æ­¥éª¤Agentçš„TTé€’å½’ä¼˜åŒ–å®Œæˆ

## ğŸ¯ æ ¸å¿ƒæ´å¯Ÿ

ä½ è¯´å¾—å®Œå…¨æ­£ç¡®ï¼**åŸºäºTTé€’å½’è‡ªåŠ¨è¿­ä»£ç‰¹æ€§ï¼Œå¾ˆå¤šAgentå¼•ç”¨æ˜¯ä¸å¿…è¦çš„**ã€‚æˆ‘ä»¬çš„åˆ†æè¿‡ç¨‹å®Œå…¨å¯ä»¥åœ¨TTé€’å½’ä¸­é—­ç¯ã€‚

## ğŸ—ï¸ ä¸‰æ­¥éª¤Agentæ¶æ„

ä½ çš„Agentæ˜¯ä¸€ä¸ª**ä¸‰æ­¥éª¤Agent**ï¼Œåœ¨ä¸åŒé˜¶æ®µè°ƒç”¨ä¸åŒèƒ½åŠ›ï¼š

### ç¬¬ä¸€é˜¶æ®µï¼šSQLç”Ÿæˆï¼ˆplaceholderä¸­è°ƒç”¨ï¼‰
- **åœºæ™¯**ï¼šå¯¹è¿˜æ²¡æœ‰SQLçš„å ä½ç¬¦è¿›è¡Œåˆ†æç”ŸæˆSQL
- **è°ƒç”¨ä½ç½®**ï¼šplaceholderæœåŠ¡ä¸­
- **TTé€’å½’èƒ½åŠ›**ï¼šè‡ªåŠ¨å‘ç°Schema â†’ ç”ŸæˆSQL â†’ éªŒè¯SQL â†’ ä¿®å¤é—®é¢˜ â†’ å†æ¬¡éªŒè¯ â†’ ç›´åˆ°è¾¾åˆ°è´¨é‡é˜ˆå€¼

### ç¬¬äºŒé˜¶æ®µï¼šå›¾è¡¨ç”Ÿæˆï¼ˆtaskä¸­è°ƒç”¨ï¼‰
- **åœºæ™¯**ï¼šETLååŸºäºETLçš„ç»“æœï¼Œå¯¹å›¾è¡¨å ä½ç¬¦è¿›è¡Œå›¾è¡¨ç”Ÿæˆ
- **è°ƒç”¨ä½ç½®**ï¼šCelery workerä¸­
- **TTé€’å½’èƒ½åŠ›**ï¼šåˆ†æETLæ•°æ® â†’ é€‰æ‹©å›¾è¡¨ç±»å‹ â†’ ç”Ÿæˆå›¾è¡¨ â†’ ä¼˜åŒ–å›¾è¡¨ â†’ éªŒè¯æ•ˆæœ â†’ ç›´åˆ°æ»¡æ„

### ç¬¬ä¸‰é˜¶æ®µï¼šæ–‡æ¡£ç”Ÿæˆï¼ˆåŸºäºå›¾è¡¨æ•°æ®å›å¡«æ¨¡æ¿ï¼‰
- **åœºæ™¯**ï¼šåŸºäºç»è¿‡å›¾è¡¨ç”Ÿæˆåçš„æ•°æ®å›å¡«è¿›æ¨¡æ¿ï¼Œè¿›è¡ŒåŸºäºæ•°æ®çš„å°èŒƒå›´æè¿°æ”¹å†™
- **è°ƒç”¨ä½ç½®**ï¼šæ–‡æ¡£ç”ŸæˆæœåŠ¡ä¸­
- **TTé€’å½’èƒ½åŠ›**ï¼šåˆ†ææ•°æ® â†’ ç”Ÿæˆæè¿° â†’ ä¼˜åŒ–è¡¨è¾¾ â†’ è°ƒæ•´è¯­æ°” â†’ éªŒè¯è´¨é‡ â†’ ç›´åˆ°æ»¡æ„

## âœ… ä¼˜åŒ–æˆæœ

### 1. åˆ›å»ºäº†ç»Ÿä¸€çš„TTé€’å½’æ¥å£

```python
# ç»Ÿä¸€çš„TTé€’å½’æ‰§è¡Œæ¥å£
async def execute_tt_recursion(
    question: str,
    data_source_id: int,
    user_id: str,
    stage: str = "sql_generation",  # sql_generation/chart_generation/completion
    complexity: str = "medium",
    context: Optional[Dict[str, Any]] = None,
    max_iterations: Optional[int] = None,
    container: Optional[Container] = None
) -> TTRecursionResponse:
```

### 2. æä¾›äº†ä¸‰æ­¥éª¤ä¸“ç”¨å‡½æ•°

```python
# ç¬¬ä¸€é˜¶æ®µï¼šSQLç”Ÿæˆ
sql_result = await execute_sql_generation_tt(
    placeholder="åˆ†æé”€å”®æ•°æ®ï¼Œç”Ÿæˆæœˆåº¦é”€å”®æŠ¥è¡¨",
    data_source_id=1,
    user_id="user_123"
)

# ç¬¬äºŒé˜¶æ®µï¼šå›¾è¡¨ç”Ÿæˆ
chart_result = await execute_chart_generation_tt(
    chart_placeholder="ç”Ÿæˆé”€å”®è¶‹åŠ¿å›¾è¡¨",
    etl_data=etl_processed_data,
    user_id="user_123"
)

# ç¬¬ä¸‰é˜¶æ®µï¼šæ–‡æ¡£ç”Ÿæˆ
document_result = await execute_document_generation_tt(
    paragraph_context="ç”Ÿæˆé”€å”®æŠ¥å‘Šæè¿°",
    placeholder_data={"sql": sql_result, "chart": chart_result},
    user_id="user_123"
)
```

### 3. æ¶ˆé™¤äº†ä¸å¿…è¦çš„ä¸­é—´å±‚

**ä¹‹å‰**ï¼šæ¯ä¸ªåœ°æ–¹éƒ½è¦é‡å¤å¤æ‚çš„Agentè°ƒç”¨æ¨¡å¼
```python
# å¤æ‚çš„æ¨¡å¼
container = Container()
agent_facade = create_stage_aware_facade(container=container, enable_context_retriever=True)
await agent_facade.initialize(user_id=user_id, task_type="task", task_complexity=complexity)

result = None
async for event in agent_facade.execute_sql_generation_stage(...):
    if event.event_type == 'execution_completed':
        result = event.data
        break
```

**ç°åœ¨**ï¼šåªéœ€è¦ä¸€è¡Œè°ƒç”¨ï¼ŒTTé€’å½’è‡ªåŠ¨è¿­ä»£åˆ°æ»¡æ„ç»“æœ
```python
# ç®€åŒ–çš„æ¨¡å¼
result = await execute_sql_generation_tt(
    placeholder="åˆ†æé”€å”®æ•°æ®",
    data_source_id=1,
    user_id="user_123"
)
```

## ğŸš€ å…³é”®ä¼˜åŠ¿

### 1. ä»£ç ç®€åŒ–
- **å‡å°‘80%çš„Agentè°ƒç”¨ä»£ç **
- **æ¶ˆé™¤é‡å¤çš„åˆå§‹åŒ–é€»è¾‘**
- **ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼**

### 2. æ€§èƒ½æå‡
- **å‡å°‘ä¸å¿…è¦çš„ä¸­é—´å±‚**
- **åˆ©ç”¨TTé€’å½’çš„è‡ªåŠ¨ä¼˜åŒ–**
- **æ›´å¥½çš„ä¸Šä¸‹æ–‡ç®¡ç†**

### 3. ç»´æŠ¤æ€§æå‡
- **ç»Ÿä¸€çš„è°ƒç”¨æ¨¡å¼**
- **æ›´å°‘çš„ä»£ç é‡å¤**
- **æ›´æ¸…æ™°çš„æ¶æ„**

## ğŸ’¡ æ ¸å¿ƒä»·å€¼

**TTé€’å½’çš„æ ¸å¿ƒä»·å€¼**ï¼š
1. **è‡ªåŠ¨è¿­ä»£**ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†è¿­ä»£è¿‡ç¨‹
2. **è´¨é‡ä¿è¯**ï¼šè‡ªåŠ¨è¾¾åˆ°è´¨é‡é˜ˆå€¼
3. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šè‡ªåŠ¨ç®¡ç†å·¥å…·è°ƒç”¨å’Œä¸Šä¸‹æ–‡
4. **é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨å¤„ç†æ‰§è¡Œé”™è¯¯

**å› æ­¤**ï¼šæˆ‘ä»¬åªéœ€è¦å®šä¹‰è¾“å…¥éœ€æ±‚ï¼ŒTTé€’å½’ä¼šè‡ªåŠ¨è¿­ä»£åˆ°æ»¡æ„ç»“æœï¼Œæ— éœ€å¤æ‚çš„ä¸­é—´å±‚å’Œé‡å¤è°ƒç”¨ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
backend/app/services/infrastructure/agents/
â”œâ”€â”€ tt_recursion.py              # TTé€’å½’ç»Ÿä¸€æ¥å£
â”œâ”€â”€ facade.py                    # StageAwareFacadeï¼ˆä¸‰æ­¥éª¤æ”¯æŒï¼‰
â”œâ”€â”€ runtime.py                   # StageAwareRuntimeï¼ˆTTé€’å½’å®ç°ï¼‰
â”œâ”€â”€ types.py                     # ExecutionStageç­‰ç±»å‹å®šä¹‰
â””â”€â”€ __init__.py                  # å¯¼å‡ºæ‰€æœ‰æ¥å£

backend/docs/
â”œâ”€â”€ AGENT_OPTIMIZATION_PLAN.md   # ä¼˜åŒ–è®¡åˆ’
â””â”€â”€ three_stage_agent_example.py # ä½¿ç”¨ç¤ºä¾‹
```

## ğŸ‰ æ€»ç»“

ä½ çš„æ´å¯Ÿéå¸¸å‡†ç¡®ï¼**TTé€’å½’çš„è‡ªåŠ¨è¿­ä»£ç‰¹æ€§ç¡®å®å¯ä»¥å¤§å¹…ç®€åŒ–Agentçš„ä½¿ç”¨**ã€‚é€šè¿‡åˆ›å»ºç»Ÿä¸€çš„ä¸‰æ­¥éª¤TTé€’å½’æ¥å£ï¼Œæˆ‘ä»¬ï¼š

1. **æ¶ˆé™¤äº†ä¸å¿…è¦çš„Agentå¼•ç”¨**
2. **ç®€åŒ–äº†è°ƒç”¨æ¨¡å¼**
3. **ä¿æŒäº†TTé€’å½’çš„è‡ªåŠ¨è¿­ä»£èƒ½åŠ›**
4. **æä¾›äº†æ¸…æ™°çš„ä¸‰æ­¥éª¤æ¶æ„**

ç°åœ¨ï¼Œæ¯ä¸ªé˜¶æ®µåªéœ€è¦ä¸€è¡Œè°ƒç”¨ï¼ŒTTé€’å½’ä¼šè‡ªåŠ¨è¿­ä»£åˆ°æ»¡æ„ç»“æœï¼Œæ— éœ€å¤æ‚çš„ä¸­é—´å±‚å’Œé‡å¤ä»£ç ã€‚
