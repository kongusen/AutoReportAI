# Doris SQLç”Ÿæˆæç¤ºè¯æ›´æ–°æ€»ç»“

## æ›´æ–°æ¦‚è¿°

æˆåŠŸæ›´æ–°äº†Agentç³»ç»Ÿçš„SQLç”Ÿæˆæç¤ºè¯ï¼Œç¡®ä¿ç”Ÿæˆçš„SQLç¬¦åˆDorisæ•°æ®åº“è§„èŒƒï¼Œå¹¶å¼ºåˆ¶ä½¿ç”¨æ—¶é—´å ä½ç¬¦ `{{start_date}}` å’Œ `{{end_date}}`ï¼Œç¦æ­¢ç¡¬ç¼–ç æ—¥æœŸå€¼ã€‚

## æ›´æ–°çš„æ–‡ä»¶

### 1. SQLç”Ÿæˆæ¨¡æ¿
**æ–‡ä»¶**: `backend/app/services/infrastructure/agents/prompts/templates.py`

**ä¸»è¦æ›´æ–°**:
- æ˜Žç¡®æŒ‡å®šç”ŸæˆDoris SQLæŸ¥è¯¢
- æ·»åŠ Dorisæ•°æ®åº“è§„èŒƒè¯´æ˜Ž
- å¼ºåˆ¶è¦æ±‚ä½¿ç”¨æ—¶é—´å ä½ç¬¦ `{{start_date}}` å’Œ `{{end_date}}`
- ç¦æ­¢ç¡¬ç¼–ç ä»»ä½•æ—¥æœŸå€¼
- æä¾›Doris SQLç¤ºä¾‹å’Œæœ€ä½³å®žè·µ
- æ·»åŠ è´¨é‡æ£€æŸ¥æ¸…å•

**å…³é”®å†…å®¹**:
```markdown
## ðŸŽ¯ Doris æ•°æ®åº“è§„èŒƒï¼ˆå¿…é¡»éµå®ˆï¼‰

### 1. Doris è¯­æ³•ç‰¹æ€§
- ä½¿ç”¨æ ‡å‡† SQL è¯­æ³•ï¼Œå…¼å®¹ MySQL
- æ”¯æŒ OLAP åˆ†æžæŸ¥è¯¢
- æ”¯æŒåˆ—å¼å­˜å‚¨å’Œå‘é‡åŒ–æ‰§è¡Œ
- æ”¯æŒå¤šç§æ•°æ®ç±»åž‹ï¼šTINYINT, SMALLINT, INT, BIGINT, LARGEINT, FLOAT, DOUBLE, DECIMAL, DATE, DATETIME, CHAR, VARCHAR, STRING, BOOLEAN, JSON

### 2. Doris æŸ¥è¯¢ä¼˜åŒ–
- ä¼˜å…ˆä½¿ç”¨åˆ†åŒºå­—æ®µè¿›è¡Œè¿‡æ»¤
- åˆç†ä½¿ç”¨èšåˆå‡½æ•°ï¼šSUM, COUNT, AVG, MAX, MIN, GROUP_CONCAT
- æ”¯æŒçª—å£å‡½æ•°ï¼šROW_NUMBER, RANK, DENSE_RANK, LAG, LEAD
- æ”¯æŒå­æŸ¥è¯¢å’Œ CTE (WITH å­å¥)

## âš ï¸ æ—¶é—´å ä½ç¬¦è¦æ±‚ï¼ˆå¼ºåˆ¶éµå®ˆï¼‰

### ðŸ”¥ æ ¸å¿ƒè¦æ±‚
**æ‰€æœ‰åŸºäºŽæ—¶é—´å‘¨æœŸçš„æŸ¥è¯¢å¿…é¡»ä½¿ç”¨æ—¶é—´å ä½ç¬¦ï¼Œç¦æ­¢ç¡¬ç¼–ç æ—¥æœŸï¼**

### å¿…éœ€çš„æ—¶é—´å ä½ç¬¦
- **{{start_date}}**: æ•°æ®å¼€å§‹æ—¶é—´ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
- **{{end_date}}**: æ•°æ®ç»“æŸæ—¶é—´ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
```

### 2. ç³»ç»Ÿæç¤ºè¯
**æ–‡ä»¶**: `backend/app/services/infrastructure/agents/prompts/system.py`

**ä¸»è¦æ›´æ–°**:
- æ›´æ–°SQLç”Ÿæˆèƒ½åŠ›æè¿°ï¼Œæ˜Žç¡®Dorisè§„èŒƒ
- å¼ºè°ƒæ—¶é—´å ä½ç¬¦ä½¿ç”¨è¦æ±‚
- æ›´æ–°SQLç”Ÿæˆé˜¶æ®µæŒ‡å¯¼ï¼ŒåŒ…å«Dorisç‰¹å®šè¦æ±‚

**å…³é”®å†…å®¹**:
```markdown
### 2. SQL ç”Ÿæˆèƒ½åŠ›
- ç”Ÿæˆç¬¦åˆDorisæ•°æ®åº“è¯­æ³•è§„èŒƒçš„SQLæŸ¥è¯¢
- æ”¯æŒå¤æ‚æŸ¥è¯¢ï¼šå¤šè¡¨å…³è”ã€å­æŸ¥è¯¢ã€çª—å£å‡½æ•°ç­‰
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½å’Œå¯è¯»æ€§
- **å¿…é¡»ä½¿ç”¨æ—¶é—´å ä½ç¬¦ {{start_date}} å’Œ {{end_date}}ï¼Œç¦æ­¢ç¡¬ç¼–ç æ—¥æœŸ**
```

### 3. Agentè¿è¡Œæ—¶é»˜è®¤æç¤ºè¯
**æ–‡ä»¶**: `backend/app/services/infrastructure/agents/runtime.py`

**ä¸»è¦æ›´æ–°**:
- æ›´æ–°é»˜è®¤ç³»ç»Ÿæç¤ºè¯ï¼Œå¼ºè°ƒDorisè§„èŒƒ
- æ·»åŠ æ—¶é—´å ä½ç¬¦ä½¿ç”¨ç¤ºä¾‹
- æ›´æ–°TTé€’å½’æ‰§è¡Œæµç¨‹ï¼ŒåŒ…å«æ—¶é—´è¿‡æ»¤è¦æ±‚

**å…³é”®å†…å®¹**:
```markdown
## ðŸ”¥ å…³é”®è¦æ±‚
- **å¿…é¡»ä½¿ç”¨Doriså…¼å®¹çš„SQLè¯­æ³•**
- **å¿…é¡»åŒ…å«æ—¶é—´å ä½ç¬¦ {{start_date}} å’Œ {{end_date}}**
- **ç¦æ­¢ç¡¬ç¼–ç ä»»ä½•æ—¥æœŸå€¼**
- **æ‰€æœ‰æ—¶é—´ç›¸å…³æŸ¥è¯¢å¿…é¡»ä½¿ç”¨æ—¶é—´è¿‡æ»¤æ¡ä»¶**

## Doris SQLç¤ºä¾‹
```sql
-- âœ… æ­£ç¡®ç¤ºä¾‹
SELECT COUNT(*) AS total_count
FROM sales_table 
WHERE sale_date >= '{{start_date}}' 
  AND sale_date <= '{{end_date}}'

-- âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆç¡¬ç¼–ç æ—¥æœŸï¼‰
SELECT COUNT(*) FROM sales_table 
WHERE sale_date >= '2024-01-01' AND sale_date <= '2024-01-31'
```
```

### 4. é˜¶æ®µé…ç½®ç®¡ç†å™¨
**æ–‡ä»¶**: `backend/app/services/infrastructure/agents/config/stage_config.py`

**ä¸»è¦æ›´æ–°**:
- æ›´æ–°SQLé˜¶æ®µç³»ç»Ÿæç¤ºè¯
- å¼ºè°ƒDorisè§„èŒƒå’Œæ—¶é—´å ä½ç¬¦è¦æ±‚
- æ·»åŠ Doris SQLç¤ºä¾‹

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
**æ–‡ä»¶**: `backend/scripts/test_doris_sql_prompts.py`

**æµ‹è¯•å†…å®¹**:
- SQLç”Ÿæˆæ¨¡æ¿å†…å®¹æ£€æŸ¥
- ç³»ç»Ÿæç¤ºè¯å†…å®¹æ£€æŸ¥
- SQLé˜¶æ®µæç¤ºè¯å†…å®¹æ£€æŸ¥
- æç¤ºè¯ä¸€è‡´æ€§æ£€æŸ¥

**æµ‹è¯•ç»“æžœ**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

## å…³é”®ç‰¹æ€§

### 1. Dorisæ•°æ®åº“è§„èŒƒ
- æ˜Žç¡®æŒ‡å®šä½¿ç”¨Doriså…¼å®¹çš„SQLè¯­æ³•
- æä¾›Dorisç‰¹æœ‰çš„æ•°æ®ç±»åž‹å’Œå‡½æ•°è¯´æ˜Ž
- åŒ…å«Dorisæ€§èƒ½ä¼˜åŒ–å»ºè®®

### 2. å¼ºåˆ¶æ—¶é—´å ä½ç¬¦ä½¿ç”¨
- å¿…é¡»ä½¿ç”¨ `{{start_date}}` å’Œ `{{end_date}}` å ä½ç¬¦
- ç¦æ­¢ç¡¬ç¼–ç ä»»ä½•æ—¥æœŸå€¼
- æä¾›æ­£ç¡®å’Œé”™è¯¯çš„SQLç¤ºä¾‹å¯¹æ¯”

### 3. è´¨é‡ä¿è¯
- æ·»åŠ è´¨é‡æ£€æŸ¥æ¸…å•
- åŒ…å«éªŒè¯æ­¥éª¤å’Œå·¥å…·ä½¿ç”¨æŒ‡å¯¼
- æä¾›é”™è¯¯ç¤ºä¾‹å’Œæ­£ç¡®ç¤ºä¾‹å¯¹æ¯”

### 4. ä¸€è‡´æ€§ä¿è¯
- æ‰€æœ‰ç›¸å…³æç¤ºè¯ä¿æŒä¸€è‡´
- ç³»ç»Ÿæç¤ºè¯ã€æ¨¡æ¿æç¤ºè¯ã€é˜¶æ®µæç¤ºè¯éƒ½åŒ…å«ç›¸åŒè¦æ±‚
- ç¡®ä¿Agentåœ¨ä¸åŒé˜¶æ®µéƒ½èƒ½æ­£ç¡®ç†è§£è¦æ±‚

## é¢„æœŸæ•ˆæžœ

### 1. SQLç”Ÿæˆè´¨é‡æå‡
- Agentç”Ÿæˆçš„SQLå°†ç¬¦åˆDorisè§„èŒƒ
- æ‰€æœ‰æ—¶é—´ç›¸å…³æŸ¥è¯¢éƒ½ä¼šä½¿ç”¨å ä½ç¬¦
- å‡å°‘ç¡¬ç¼–ç æ—¥æœŸå¯¼è‡´çš„ç»´æŠ¤é—®é¢˜

### 2. å­˜å‚¨ç­–ç•¥ä¼˜åŒ–
- ç”Ÿæˆçš„SQLåŒ…å«æ—¶é—´å ä½ç¬¦ï¼Œå¯ä»¥åœ¨ä¸åŒå‘¨æœŸé‡å¤ä½¿ç”¨
- åœ¨ETLé˜¶æ®µæ‰è¿›è¡Œæ—¶é—´å ä½ç¬¦æ›¿æ¢
- æé«˜SQLçš„å¯é‡ç”¨æ€§å’Œç»´æŠ¤æ€§

### 3. å¼€å‘æ•ˆçŽ‡æå‡
- å‡å°‘æ‰‹åŠ¨ä¿®æ”¹SQLçš„å·¥ä½œé‡
- æé«˜SQLç”Ÿæˆçš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§
- é™ä½Žå› ç¡¬ç¼–ç æ—¥æœŸå¯¼è‡´çš„é”™è¯¯

## ä½¿ç”¨ç¤ºä¾‹

### æ­£ç¡®çš„SQLç”Ÿæˆ
```sql
-- Agentå°†ç”Ÿæˆè¿™æ ·çš„SQL
SELECT COUNT(*) AS total_count
FROM sales_table 
WHERE sale_date >= '{{start_date}}' 
  AND sale_date <= '{{end_date}}'
```

### ETLé˜¶æ®µæ›¿æ¢
```python
# åœ¨ETLé˜¶æ®µè¿›è¡Œæ—¶é—´å ä½ç¬¦æ›¿æ¢
from app.utils.sql_placeholder_utils import SqlPlaceholderReplacer

sql_replacer = SqlPlaceholderReplacer()
time_context = {
    'data_start_time': '2024-01-01',
    'data_end_time': '2024-01-31'
}

final_sql = sql_replacer.replace_time_placeholders(generated_sql, time_context)
# ç»“æžœ: SELECT COUNT(*) AS total_count FROM sales_table WHERE sale_date >= '2024-01-01' AND sale_date <= '2024-01-31'
```

## æ€»ç»“

é€šè¿‡è¿™æ¬¡æç¤ºè¯æ›´æ–°ï¼Œæˆ‘ä»¬ç¡®ä¿äº†ï¼š

1. **Agentç”Ÿæˆçš„SQLç¬¦åˆDorisè§„èŒƒ**ï¼Œæé«˜æ•°æ®åº“å…¼å®¹æ€§
2. **å¼ºåˆ¶ä½¿ç”¨æ—¶é—´å ä½ç¬¦**ï¼Œé¿å…ç¡¬ç¼–ç æ—¥æœŸå€¼
3. **æé«˜SQLçš„å¯é‡ç”¨æ€§**ï¼Œæ”¯æŒä¸åŒå‘¨æœŸçš„ä»»åŠ¡æ‰§è¡Œ
4. **ä¿æŒæç¤ºè¯ä¸€è‡´æ€§**ï¼Œç¡®ä¿Agentåœ¨ä¸åŒé˜¶æ®µéƒ½èƒ½æ­£ç¡®ç†è§£è¦æ±‚
5. **æä¾›å®Œæ•´çš„ç¤ºä¾‹å’ŒæŒ‡å¯¼**ï¼Œå¸®åŠ©Agentç”Ÿæˆé«˜è´¨é‡çš„SQL

è¿™äº›æ›´æ–°å°†æ˜¾è‘—æå‡å ä½ç¬¦åˆ†æžä»»åŠ¡ä¸­SQLç”Ÿæˆçš„è´¨é‡å’Œå¯ç»´æŠ¤æ€§ï¼Œä¸ºåŽç»­çš„ETLé˜¶æ®µæä¾›æ›´å¥½çš„åŸºç¡€ã€‚
