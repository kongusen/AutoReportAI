# AutoReportAI Services ä¾èµ–å…³ç³»åˆ†ææŠ¥å‘Š

## æ¦‚è¿°
æœ¬æŠ¥å‘Šè¯¦ç»†åˆ†æäº† `/Users/shan/work/me/AutoReportAI/backend/app/services` ç›®å½•ä¸‹7ä¸ªå…³é”®æ¨¡å—çš„ä»£ç ä¾èµ–å…³ç³»ï¼ŒåŒ…æ‹¬æ¨¡å—é—´çš„importä¾èµ–ã€å¾ªç¯ä¾èµ–è¯†åˆ«ã€è€¦åˆåº¦åˆ†æç­‰ã€‚

## å…³é”®æ¨¡å—åˆ—è¡¨
1. **placeholder/** - å ä½ç¬¦å¤„ç†ç³»ç»Ÿ
2. **agents/** - AIä»£ç†ç³»ç»Ÿ 
3. **ai_integration/** - AIé›†æˆæœåŠ¡
4. **template/** - æ¨¡æ¿å¤„ç†æœåŠ¡
5. **connectors/** - æ•°æ®è¿æ¥å™¨
6. **task/** - ä»»åŠ¡æ‰§è¡Œç³»ç»Ÿ
7. **data_processing/** - æ•°æ®å¤„ç†æœåŠ¡

## 1. æ¨¡å—ä¾èµ–å…³ç³»çŸ©é˜µ

| ä»\åˆ° | placeholder | agents | ai_integration | template | connectors | task | data_processing |
|-------|-------------|--------|----------------|----------|------------|------|----------------|
| **placeholder** | - | âœ“ | âœ— | âœ“ | âœ— | âœ— | âœ— |
| **agents** | âœ— | - | âœ“ | âœ— | âœ“ | âœ— | âœ— |
| **ai_integration** | âœ— | âœ— | - | âœ— | âœ— | âœ— | âœ— |
| **template** | âœ“ | âœ“ | âœ— | - | âœ“ | âœ— | âœ— |
| **connectors** | âœ— | âœ— | âœ— | âœ— | - | âœ— | âœ— |
| **task** | âœ— | âœ“ | âœ“ | âœ“ | âœ— | - | âœ“ |
| **data_processing** | âœ— | âœ“ | âœ— | âœ— | âœ“ | âœ— | - |

**è¯´æ˜:**
- âœ“ = å­˜åœ¨ä¾èµ–å…³ç³»
- âœ— = æ— ç›´æ¥ä¾èµ–å…³ç³»

## 2. è¯¦ç»†ä¾èµ–å…³ç³»åˆ†æ

### 2.1 placeholder æ¨¡å—ä¾èµ–
**å¯¹å¤–ä¾èµ–:**
- `agents` - ä½¿ç”¨AIä»£ç†è¿›è¡Œå ä½ç¬¦åˆ†æ
- `template` - ä¾èµ–æŠ¥å‘Šç”Ÿæˆçš„æ–‡æ¡£ç®¡é“

**å…³é”®ä¾èµ–æ–‡ä»¶:**
- `placeholder/extraction/extractor.py` â†’ `app.services.report_generation.document_pipeline`
- `placeholder/router.py` â†’ Agentåˆ†ææœåŠ¡

### 2.2 agents æ¨¡å—ä¾èµ–  
**å¯¹å¤–ä¾èµ–:**
- `ai_integration` - ç»Ÿä¸€AIæœåŠ¡æ¥å£
- `connectors` - å¤šæ•°æ®åº“ä»£ç†éœ€è¦æ•°æ®è¿æ¥å™¨

**å…³é”®ä¾èµ–æ–‡ä»¶:**
- `agents/core/ai_service.py` â†’ `app.services.ai_integration.EnhancedAIService`
- `agents/multi_database_agent.py` â†’ `app.services.connectors.doris_connector`

### 2.3 template æ¨¡å—ä¾èµ–
**å¯¹å¤–ä¾èµ–:**  
- `placeholder` - åˆ›å»ºå ä½ç¬¦æå–å™¨
- `agents` - ä½¿ç”¨å¤šæ•°æ®åº“ä»£ç†è¿›è¡ŒSQLåˆ†æ
- `connectors` - è¿æ¥å™¨å·¥å‚

**å…³é”®ä¾èµ–æ–‡ä»¶:**
- `template/enhanced_template_parser.py` â†’ `app.services.placeholder`
- `template/agent_sql_analysis_service.py` â†’ `app.services.agents.multi_database_agent`

### 2.4 task æ¨¡å—ä¾èµ– (æœ€é«˜è€¦åˆ)
**å¯¹å¤–ä¾èµ–:**
- `agents` - ä»£ç†ç¼–æ’å™¨
- `ai_integration` - å¢å¼ºAIæœåŠ¡  
- `template` - å¢å¼ºæ¨¡æ¿è§£æå™¨
- `data_processing` - ETLæ‰§è¡Œå™¨

**å…³é”®ä¾èµ–æ–‡ä»¶:**
- `task/execution/two_phase_pipeline.py` â†’ ä¾èµ–å¤šä¸ªæ¨¡å—
- `task/core/worker/tasks/basic_tasks.py` â†’ ä¾èµ–6ä¸ªä¸åŒæ¨¡å—

### 2.5 data_processing æ¨¡å—ä¾èµ–
**å¯¹å¤–ä¾èµ–:**
- `agents` - Schemaåˆ†æä»£ç†  
- `connectors` - Dorisè¿æ¥å™¨

**å…³é”®ä¾èµ–æ–‡ä»¶:**
- `data_processing/schema_aware_analysis.py` â†’ Schemaç®¡ç†æœåŠ¡
- `data_processing/etl/intelligent_etl_executor.py` â†’ Dorisè¿æ¥å™¨

## 3. å¾ªç¯ä¾èµ–åˆ†æ

### 3.1 æ£€æµ‹åˆ°çš„å¾ªç¯ä¾èµ–

#### ğŸ”´ å¾ªç¯ä¾èµ– #1: template â†” placeholder
```
template/enhanced_template_parser.py 
  â†’ app.services.placeholder.create_placeholder_extractor

placeholder/extraction/extractor.py 
  â†’ app.services.report_generation.document_pipeline (templateç›¸å…³)
```

#### ğŸ”´ å¾ªç¯ä¾èµ– #2: agents â†” template  
```
template/agent_sql_analysis_service.py 
  â†’ app.services.agents.multi_database_agent

agents/orchestration/cached_orchestrator.py 
  â†’ app.services.template.enhanced_template_parser
  â†’ app.services.template.agent_sql_analysis_service
```

### 3.2 æ½œåœ¨å¾ªç¯ä¾èµ–é£é™©
- `task` æ¨¡å—å¯¹å¤šä¸ªæ¨¡å—çš„é‡åº¦ä¾èµ–å¯èƒ½å½¢æˆé—´æ¥å¾ªç¯

## 4. è€¦åˆåº¦åˆ†æ

### 4.1 ä¾èµ–æ·±åº¦ç»Ÿè®¡

| æ¨¡å— | å‡ºå‘ä¾èµ–æ•° | å…¥å‘ä¾èµ–æ•° | è€¦åˆåº¦è¯„åˆ† | é£é™©ç­‰çº§ |
|------|------------|------------|------------|----------|
| **task** | 4 | 0 | ğŸ”´ Very High | é«˜é£é™© |
| **template** | 3 | 2 | ğŸŸ¡ High | ä¸­ç­‰é£é™© |
| **agents** | 2 | 2 | ğŸŸ¡ Medium | ä¸­ç­‰é£é™© |
| **data_processing** | 2 | 1 | ğŸŸ¢ Medium | ä½é£é™© |
| **placeholder** | 2 | 1 | ğŸŸ¢ Medium | ä½é£é™© |
| **connectors** | 0 | 3 | ğŸŸ¢ Low | ä½é£é™© |
| **ai_integration** | 0 | 2 | ğŸŸ¢ Low | ä½é£é™© |

### 4.2 é«˜è€¦åˆæ¨¡å—å¯¹è¯†åˆ«

#### ğŸ”´ æœ€é«˜é£é™©: task â† â†’ (multiple modules)
- `task` æ¨¡å—ä¾èµ–è¿‡å¤šå…¶ä»–æ¨¡å—
- å•ç‚¹æ•…éšœé£é™©é«˜
- æµ‹è¯•å¤æ‚åº¦é«˜

#### ğŸŸ¡ ä¸­ç­‰é£é™©: template â†” agents  
- å­˜åœ¨åŒå‘ä¾èµ–
- ä¸šåŠ¡é€»è¾‘è¾¹ç•Œæ¨¡ç³Š

#### ğŸŸ¡ ä¸­ç­‰é£é™©: template â†” placeholder
- å¾ªç¯ä¾èµ–å¯¼è‡´ç´§è€¦åˆ
- èŒè´£åˆ’åˆ†ä¸æ¸…æ™°

## 5. ä¾èµ–å…³ç³»å¯è§†åŒ–

### 5.1 æ¨¡å—ä¾èµ–å±‚æ¬¡å›¾
```
Level 0 (åŸºç¡€å±‚):
â”œâ”€â”€ ai_integration (æ— ä¾èµ–)
â””â”€â”€ connectors (æ— ä¾èµ–)

Level 1 (æ ¸å¿ƒå±‚):  
â”œâ”€â”€ agents (ä¾èµ–: ai_integration, connectors)
â””â”€â”€ data_processing (ä¾èµ–: agents, connectors)

Level 2 (ä¸šåŠ¡å±‚):
â”œâ”€â”€ placeholder (ä¾èµ–: agents, template*)  
â””â”€â”€ template (ä¾èµ–: placeholder*, agents, connectors)

Level 3 (ç¼–æ’å±‚):
â””â”€â”€ task (ä¾èµ–: agents, ai_integration, template, data_processing)

* è¡¨ç¤ºå­˜åœ¨å¾ªç¯ä¾èµ–
```

### 5.2 ä¾èµ–æµå‘å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ai_integrationâ”‚    â”‚connectorsâ”‚    â”‚  data_processingâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                â”‚   â”‚        â”‚           â”‚         â”‚
            â”Œâ”€â”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”      â”‚
            â”‚  agents  â”‚   â”‚ placeholder â”‚      â”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                 â”‚                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
        â”‚    template      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              task                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. é£é™©è¯„ä¼°ä¸æ”¹è¿›å»ºè®®

### 6.1 é«˜é£é™©é—®é¢˜

#### ğŸ”´ ä¸¥é‡é—®é¢˜
1. **å¾ªç¯ä¾èµ–**: template â†” placeholder
   - **å½±å“**: ä»£ç éš¾ä»¥ç»´æŠ¤ï¼Œæ„å»ºé¡ºåºæ··ä¹±
   - **å»ºè®®**: æå–å…¬å…±æ¥å£ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥

2. **taskæ¨¡å—è¿‡åº¦è€¦åˆ**
   - **å½±å“**: å•ç‚¹æ•…éšœï¼Œæµ‹è¯•å›°éš¾
   - **å»ºè®®**: ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå‡å°‘ç›´æ¥ä¾èµ–

#### ğŸŸ¡ ä¸­ç­‰é—®é¢˜  
3. **agents â†” template åŒå‘ä¾èµ–**
   - **å½±å“**: èŒè´£è¾¹ç•Œæ¨¡ç³Š
   - **å»ºè®®**: æ˜ç¡®èŒè´£åˆ†å·¥ï¼Œä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼

### 6.2 æ¶æ„ä¼˜åŒ–å»ºè®®

#### å»ºè®®1: ä¾èµ–å€’ç½® 
```python
# å½“å‰é—®é¢˜: ç›´æ¥ä¾èµ–å…·ä½“å®ç°
from app.services.agents.multi_database_agent import MultiDatabaseAgent

# æ”¹è¿›æ–¹æ¡ˆ: ä¾èµ–æŠ½è±¡æ¥å£  
from app.services.agents.interfaces import IDatabaseAgent
```

#### å»ºè®®2: äº‹ä»¶é©±åŠ¨è§£è€¦
```python
# å½“å‰é—®é¢˜: taskç›´æ¥è°ƒç”¨å¤šä¸ªæ¨¡å—
def execute_task():
    agent_result = AgentOrchestrator.process()
    template_result = EnhancedTemplateParser.parse()
    
# æ”¹è¿›æ–¹æ¡ˆ: äº‹ä»¶é©±åŠ¨
def execute_task():
    event_bus.publish('task.started', task_data)
    # å„æ¨¡å—ç›‘å¬äº‹ä»¶å¹¶å¤„ç†
```

#### å»ºè®®3: åˆ†å±‚æ¶æ„å¼ºåŒ–
```
åº”ç”¨å±‚ (Application Layer)
  â”œâ”€â”€ task (ç¼–æ’ä¸åè°ƒ)
  â””â”€â”€ APIæ¥å£

ä¸šåŠ¡å±‚ (Business Layer) 
  â”œâ”€â”€ template (æ¨¡æ¿å¤„ç†)
  â”œâ”€â”€ placeholder (å ä½ç¬¦å¤„ç†)
  â””â”€â”€ agents (æ™ºèƒ½åˆ†æ)

æœåŠ¡å±‚ (Service Layer)
  â”œâ”€â”€ ai_integration (AIæœåŠ¡)
  â”œâ”€â”€ data_processing (æ•°æ®å¤„ç†)
  â””â”€â”€ notification (é€šçŸ¥æœåŠ¡)

åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)
  â””â”€â”€ connectors (æ•°æ®è¿æ¥)
```

### 6.3 é‡æ„ä¼˜å…ˆçº§

#### Phase 1 (é«˜ä¼˜å…ˆçº§)
1. è§£å†³ template â†” placeholder å¾ªç¯ä¾èµ–
2. é‡æ„ task æ¨¡å—ï¼Œå‡å°‘ç›´æ¥ä¾èµ–

#### Phase 2 (ä¸­ä¼˜å…ˆçº§)  
3. ä¼˜åŒ– agents â†” template åŒå‘ä¾èµ–
4. æå–å…¬å…±æ¥å£ï¼Œå®ç°ä¾èµ–å€’ç½®

#### Phase 3 (ä½ä¼˜å…ˆçº§)
5. å®Œå–„åˆ†å±‚æ¶æ„
6. å¼•å…¥äº‹ä»¶é©±åŠ¨æœºåˆ¶

## 7. ç›‘æ§æŒ‡æ ‡å»ºè®®

### 7.1 ä¾èµ–å¥åº·åº¦æŒ‡æ ‡
- **å¾ªç¯ä¾èµ–æ•°é‡**: ç›®æ ‡ = 0
- **æ¨¡å—å¹³å‡å‡ºå‘ä¾èµ–**: ç›®æ ‡ < 3  
- **æœ€å¤§ä¾èµ–æ·±åº¦**: ç›®æ ‡ < 4å±‚

### 7.2 å®šæœŸæ£€æŸ¥æœºåˆ¶
- æ¯å‘¨ä¾èµ–å…³ç³»æ‰«æ
- æ–°åŠŸèƒ½å¼€å‘æ—¶çš„ä¾èµ–å®¡æŸ¥  
- é‡æ„å‰åçš„ä¾èµ–å¯¹æ¯”åˆ†æ

## æ€»ç»“

å½“å‰ç³»ç»Ÿå­˜åœ¨2ä¸ªæ˜ç¡®çš„å¾ªç¯ä¾èµ–å’Œ1ä¸ªè¿‡åº¦è€¦åˆçš„æ¨¡å—(task)ã€‚å»ºè®®ä¼˜å…ˆè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œç„¶åé‡æ„taskæ¨¡å—ä»¥é™ä½æ•´ä½“ç³»ç»Ÿçš„è€¦åˆåº¦ã€‚é€šè¿‡å¼•å…¥åˆ†å±‚æ¶æ„å’Œäº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œå¯ä»¥æ˜¾è‘—æé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚