# 智能占位符系统架构重构方案

## 📋 项目概述

**目标**: 将基于文档分析的占位符处理系统重构为智能化、上下文感知的AI驱动架构，支持复杂的统计需求分析和迭代式SQL优化。

**核心特性**:
- 支持 `{{统计类型：统计需求描述}}` 格式的智能解析
- 多层次上下文分析（段落、章节、文档、业务）
- 智能权重计算和动态调整
- 迭代式SQL生成和优化
- 实时数据管理和缓存策略

---

## 🏗️ 系统架构设计

### 整体架构图

```
                          API层
                            │
                ┌──────────────────────────┐
                │   Application层         │
                │  ┌─────────────────────┐ │
                │  │  Task Workflows     │ │
                │  │  Context Builders   │ │
                │  └─────────────────────┘ │
                └──────────────────────────┘
                            │
        ┌──────────────────────────────────────────────────┐
        │                Domain层                          │
        │  ┌─────────────────┐  ┌──────────────────────┐   │
        │  │  Task Domain    │  │  Placeholder Domain  │   │
        │  │  ┌─────────────┐│  │  ┌─────────────────┐ │   │
        │  │  │TimeContext  ││  │  │  Orchestrator   │ │   │
        │  │  │Calculator   ││  │  │  ├─Parser       │ │   │
        │  │  └─────────────┘│  │  │  ├─Analyzer     │ │   │
        │  └─────────────────┘  │  │  ├─Integrator   │ │   │
        │                       │  │  └─Manager      │ │   │
        │                       │  └─────────────────┘ │   │
        │                       └──────────────────────┘   │
        └──────────────────────────────────────────────────┘
                            │
        ┌──────────────────────────────────────────────────┐
        │              LLM Agents层                        │
        │  ┌─────────────────────────────────────────────┐ │
        │  │        Business Tools Registry             │ │
        │  │  ┌───────────────┐ ┌──────────────────────┐│ │
        │  │  │ SQL Generator │ │   Context Analyzer   ││ │
        │  │  │ Data Executor │ │   Result Formatter   ││ │
        │  │  └───────────────┘ └──────────────────────┘│ │
        │  └─────────────────────────────────────────────┘ │
        │  ┌─────────────────────────────────────────────┐ │
        │  │             Intelligent Agents             │ │
        │  │ ┌──────────────┐ ┌─────────────────────────┐│ │
        │  │ │ Placeholder  │ │    Data Analysis        ││ │
        │  │ │ Analysis     │ │    Report Generation    ││ │
        │  │ │ Agent        │ │    Agents               ││ │
        │  │ └──────────────┘ └─────────────────────────┘│ │
        │  └─────────────────────────────────────────────┘ │
        └──────────────────────────────────────────────────┘
```

---

## 📝 核心组件设计

### 1. 增强占位符解析器

#### 支持的语法格式

```python
# 1. 基础格式
{{统计：本月投诉总数}}
{{趋势：投诉月度增长率}}
{{极值：投诉最多的地区}}

# 2. 参数化格式
{{统计：本月投诉总数|时间范围=2025-08|地区=昆明}}
{{列表：投诉排行榜|数量=10|排序=desc}}
{{对比：投诉数环比|对比期=上月}}

# 3. 复合格式
{{统计图：投诉趋势图|类型=折线图|时间粒度=日}}
{{组合：{统计：总投诉数|地区=昆明}占{统计：总投诉数}的比例}}

# 4. 条件格式
{{统计：投诉数|条件=总投诉>1000|分组=地区}}
{{趋势：增长率|如果=投诉类型==退货}}
```

#### 统计类型支持

```python
class StatisticalType(Enum):
    STATISTICS = "统计"      # 总和、平均值、计数
    TREND = "趋势"          # 增长率、变化趋势
    EXTREME = "极值"        # 最大值、最小值、异常值
    LIST = "列表"          # 排行榜、明细列表
    CHART = "统计图"       # 柱状图、折线图、饼图
    COMPARISON = "对比"     # 同比、环比
    FORECAST = "预测"      # 趋势预测、预估值
```

### 2. 多层次上下文分析

#### 上下文权重模型

```python
@dataclass
class ContextWeight:
    paragraph_weight: float = 0.4      # 段落上下文权重
    section_weight: float = 0.3        # 章节上下文权重  
    document_weight: float = 0.2       # 文档全局上下文权重
    business_weight: float = 0.1       # 业务规则上下文权重
```

#### 权重动态调整机制

- **基于统计类型调整**: 不同统计类型对上下文的依赖不同
- **基于上下文明确性**: 上下文越明确权重越高
- **基于反馈学习**: 根据历史效果动态优化权重
- **基于冲突解决**: 有冲突时提升局部权重

### 3. 占位符编排器 (PlaceholderOrchestrator)

#### 核心职责

- **上下文集成**: 整合多层次上下文信息
- **Agent调用**: 协调各种智能代理
- **结果管理**: 处理分析结果的存储和缓存
- **质量控制**: 确保生成结果的质量和准确性
- **演进管理**: 管理SQL的迭代优化

#### 主要接口

```python
class PlaceholderOrchestrator:
    async def analyze_with_context(
        self,
        template_id: str,
        time_context: TimeContext,
        business_context: BusinessContext
    ) -> PlaceholderAnalysisResult
    
    async def analyze_for_debug(
        self,
        template_content: str,
        debug_context: DebugContext
    ) -> DebugAnalysisResult
```

### 4. 迭代式更新机制

#### SQL演进策略

- **质量评估**: 自动评估SQL质量和执行效果
- **性能监控**: 跟踪SQL执行性能和资源使用
- **反馈收集**: 收集用户反馈和业务反馈
- **智能优化**: 基于反馈自动优化SQL
- **版本管理**: 维护SQL的版本历史和回滚能力

#### 实时数据管理

- **新鲜度检查**: 自动检查数据是否过期
- **智能刷新**: 基于业务需求智能调度数据刷新
- **增量更新**: 支持增量数据更新减少资源消耗
- **依赖管理**: 管理数据之间的依赖关系

---

## 🎯 系统特性

### 智能化特性

1. **语义理解**: 深度理解占位符的业务含义
2. **上下文感知**: 基于文档上下文智能分析
3. **自动优化**: 自动优化SQL性能和准确性
4. **学习能力**: 从反馈中持续学习改进

### 可扩展性特性

1. **插件化处理器**: 支持新统计类型的插件式扩展
2. **分析器链**: 支持新上下文分析器的动态添加
3. **权重模型**: 支持自定义权重计算策略
4. **存储后端**: 支持多种存储和缓存后端

### 性能特性

1. **智能缓存**: 基于上下文的智能缓存策略
2. **并发处理**: 支持高并发占位符分析
3. **资源控制**: 智能的资源使用控制和负载均衡
4. **监控告警**: 完善的性能监控和告警机制

---

## 📋 实施路线图

### Phase 1: 核心架构设计 ✅ 已完成
- [x] 增强占位符解析器设计
- [x] 多层次上下文权重模型设计
- [x] 占位符编排器设计
- [x] 上下文管理器设计
- [x] 迭代式更新机制设计

### Phase 2-8: 详细实施计划
参见下方完整的TODO清单

---

## 🔧 技术栈

- **后端框架**: FastAPI + SQLAlchemy
- **AI引擎**: LlamaIndex + ReAct Agents
- **LLM支持**: OpenAI, Anthropic, Ollama
- **缓存系统**: Redis + 内存缓存
- **数据库**: PostgreSQL
- **监控**: 自建性能监控系统

---

## 📊 预期效果

### 功能提升
- 支持复杂统计需求的智能分析
- 大幅提升占位符处理准确率
- 实现真正的上下文感知分析
- 支持SQL的自动优化和演进

### 性能提升  
- 智能缓存提升响应速度
- 并发处理提升系统吞吐量
- 资源优化降低系统负载
- 实时数据保证分析时效性

### 开发效率
- 统一的API接口简化集成
- 插件化架构便于扩展
- 完善的监控便于维护
- 自动化测试保证质量

---

*文档创建时间: 2024-01-28*  
*架构设计状态: ✅ 已完成*  
*实施状态: 🔄 准备开始Phase 2*